#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: Hematopoietic Cell Transplantation (HCT)
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_hct_content():
    """הוספת נושא HCT עם כל המקטעים"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: השתלת מח עצם...")
    
    topic_data = {
        "title": "השתלת מח עצם - HCT",
        "category": "hematology",
        "description": "Hematopoietic Cell Transplantation - טיפול מציל חיים, סיבוכים ומעקב",
        "icon": "🏥",
        "slug": "hematopoietic_cell_transplantation",
        "tags": ["המטולוגיה", "אונקולוגיה", "HCT", "השתלה", "מח עצם", "GVHD"],
        "order_index": 60
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "הגדרה - השתלת מח עצם",
            "section_type": "text",
            "content": """**Hematopoietic Cell Transplantation (HCT)**

השתלת מח עצם היא טיפול בעל **פוטנציאל לרפא** מחלות המטולוגיות ואונקולוגיות חמורות.

✅ **יתרונות:**
- פוטנציאל ריפוי מלא
- תקווה לחיים ארוכים

⚠️ **חסרונות:**
- שיעור גבוה של **סיבוכים**
- סיכון משמעותי ל**מוות**

⏰ **טווח זמן קריטי:**
סיבוכים ומקרי מוות נפוצים ב**שנה הראשונה** להשתלה""",
            "order_index": 0
        },
        {
            "title": "למה כל כך מסוכן?",
            "section_type": "text",
            "content": """שתי סיבות עיקריות:

1. **דיכוי חיסוני אינטנסיבי**
   - מערכת החיסון מדוכאת לחלוטין
   - פגיעות קיצונית לזיהומים

2. **תרופות ציטוטוקסיות**
   - נזק לרקמות בריאות
   - רעילות לאברים שונים

💡 **חדשות טובות:**
הסיבוכים בדרך כלל **דועכים עם הזמן**

⏰ **סיבוכים מאוחרים:**
יכולים להשפיע על אברים רבים, אך **לרוב החולים יכולים לחזור לשגרה**""",
            "order_index": 1
        },
        {
            "title": "התוויות להשתלת מח עצם",
            "section_type": "list",
            "content": """**מחלות שניתן לטפל בהן באמצעות HCT:**

🎗️ **לוקמיה**
- ALL (Acute Lymphoblastic Leukemia)
- AML (Acute Myeloid Leukemia)
- CML (Chronic Myeloid Leukemia)

🎗️ **לימפומה**
- הודג'קין
- Non-Hodgkin

🩸 **המוגלובינופתיה**
- Sickle Cell Disease
- Thalassemia

🩸 **אנמיה אפלסטית**

🛡️ **הפרעות חיסוניות**
- SCID
- הפרעות נוספות

💡 **ועוד מחלות רבות...**""",
            "order_index": 2
        },
        {
            "title": "הכנה להשתלה",
            "section_type": "alert",
            "content": """🔬 **Conditioning - התאמת הגוף לקליטת השתל**

**לפני ההשתלה:**
מתאימים **כימותרפיה** (ולעיתים הקרנות) כדי:

1. **למגר** את מח העצם הקיים
2. **לדכא** את מערכת החיסון
3. **לאפשר** לשתל החדש להיקלט

⚠️ זהו שלב קריטי ומסוכן!""",
            "order_index": 3
        },
        {
            "title": "סיבוכים בטווח הקצר",
            "section_type": "text",
            "content": """⏰ **בשנה הראשונה להשתלה:**

הסיבוכים השכיחים והמסוכנים ביותר:""",
            "order_index": 4
        },
        {
            "title": "1. זיהומים",
            "section_type": "text",
            "content": """🦠 **הסיבוך הנפוץ והמסוכן ביותר**

**למה?**
- מערכת החיסון מדוכאת לחלוטין
- אין הגנה מפני חיידקים, וירוסים, פטריות

**זיהומים נפוצים:**
- חיידקים: G+ ו-G-
- וירוסים: CMV, EBV, Adenovirus, BK virus, HHV6
- פטריות: Candida, Aspergillus

💊 **מניעה:**
- אנטיביוטיקה פרופילקטית
- תרופות אנטי-ויראליות
- ניטור מתמיד""",
            "order_index": 5
        },
        {
            "title": "2. SOS - חסימת סינוסים בכבד",
            "section_type": "text",
            "content": """**Hepatic Sinusoidal Obstruction Syndrome (SOS)**
(לשעבר: Veno-Occlusive Disease - VOD)

**מה זה?**
חסימה של כלי הדם הקטנים בכבד

**ביטויים קליניים:**
- צהבת
- הגדלת כבד
- כאבי בטן
- עלייה במשקל (אגירת נוזלים)
- אסציטס

⚠️ **מסוכן מאוד!** יכול להוביל לאי ספיקת כבד""",
            "order_index": 6
        },
        {
            "title": "3. TMA - מיקרואנגיופתיה טרומבוטית",
            "section_type": "text",
            "content": """**Transplant-Associated Thrombotic Microangiopathy (TA-TMA)**

**מה זה?**
פגיעה בכלי דם קטנים עם:
- המוליזה (הרס תאי דם אדומים)
- טרומבוציטופניה
- פגיעה בכליות

**ביטויים:**
- אנמיה המוליטית מיקרואנגיופתית
- אי ספיקה כלייתית
- יתר לחץ דם
- בצקות

💔 **פרוגנוזה:** יכול להיות קטלני""",
            "order_index": 7
        },
        {
            "title": "4. דלקת ריאות אינטרסטיציאלית",
            "section_type": "text",
            "content": """**Interstitial Pneumonia**

**מה זה?**
דלקת ברקמת הריאה (אינטרסטיציום)

**גורמים:**
- זיהומיים: CMV, PCP, פטריות
- לא זיהומיים: רעילות תרופתית, GVHD

**ביטויים:**
- קוצר נשימה
- שיעול יבש
- חום
- ירידה בסטורציה

🫁 **טיפול:** תלוי בגורם - אנטיביוטיקה/אנטי-ויראליים או סטרואידים""",
            "order_index": 8
        },
        {
            "title": "5. aGVHD - Acute Graft Versus Host Disease",
            "section_type": "text",
            "content": """**דלקת חריפה של השתל נגד המארח**

**מה זה?**
תאי T מהתורם תוקפים את רקמות הנתרם

**מתי?**
בדרך כלל ב**100 הימים הראשונים** להשתלה

**איברים מושפעים:**
1. **עור** - פריחה, אודם
2. **מעיים** - שלשולים, כאבי בטן, דימומים
3. **כבד** - צהבת, עלייה באנזימי כבד

**חומרה:**
- Grade I-IV
- Grade IV = מסכן חיים

💊 **טיפול:**
- סטרואידים במינון גבוה
- דיכוי חיסוני מוגבר
- טיפול תומך""",
            "order_index": 9
        },
        {
            "title": "סיבוכים בטווח הארוך",
            "section_type": "text",
            "content": """⏰ **לאחר שנה מההשתלה ואילך:**

סיבוכים שיכולים להתפתח או להימשך לאורך שנים:""",
            "order_index": 10
        },
        {
            "title": "cGVHD - Chronic Graft Versus Host Disease",
            "section_type": "text",
            "content": """**דלקת כרונית של השתל נגד המארח**

**מה זה?**
תגובה חיסונית ממושכת שדומה למחלה אוטואימונית

**מתי?**
בדרך כלל **מעל 100 ימים** להשתלה, אך יכול להמשך שנים

**איברים מושפעים:**
- עור: יובש, גרד, הקשחה (scleroderma-like)
- עיניים: יובש, דלקות
- פה: יובש, כיבים, הגבלת פתיחת פה
- כבד: כולסטזיס
- ריאות: ברונכיוליטיס אובליטרנס
- מפרקים: הגבלת תנועה
- מעיים: שלשולים, ספיגה לקויה

**גורמי סיכון:**
- רמת ההתאמה בין התורם לנתרם (↓ התאמה = ↑ סיכון)
- aGVHD קודם
- גיל מבוגר

**מניעה:**
💊 **דיכוי תאי T לפני ההשתלה** (T-cell depletion)

**טיפול:**
- סטרואידים ממושכים
- דיכוי חיסוני
- טיפול בסיבוכים האיברים הספציפיים""",
            "order_index": 11
        },
        {
            "title": "הפרעות אנדוקריניות",
            "section_type": "list",
            "content": """**השפעות ארוכות טווח על מערכות הורמונליות:**

🧬 **הפרעות גדילה**
- פגיעה בציר הורמון הגדילה
- קומה נמוכה
- עיכוב בהתבגרות מינית

🦴 **אוסטאופורוזיס**
- עקב סטרואידים ממושכים
- חוסר בוויטמין D

🦋 **בעיות תירואיד**
- היפותירואידיזם
- נזק מהקרנות/כימותרפיה

🍬 **סוכרת**
- עקב סטרואידים
- פגיעה בלבלב

💡 **חשוב:** מעקב אנדוקרינולוגי שוטף חיוני!""",
            "order_index": 12
        },
        {
            "title": "הפרעות נוירוקוגניטיביות",
            "section_type": "text",
            "content": """🧠 **פגיעה בתפקוד הקוגניטיבי**

**ביטויים:**
- קשיי ריכוז וקשב
- בעיות זיכרון
- קשיי למידה
- ירידה בתפקוד ביצועי

**גורמים:**
- כימותרפיה (בעיקר מתוטרקסט אינטרתקלי)
- הקרנות למוח
- זיהומים בCNS
- תרופות נוספות

👨‍🏫 **טיפול:**
- שיקום קוגניטיבי
- תמיכה חינוכית
- מעקב נוירופסיכולוגי""",
            "order_index": 13
        },
        {
            "title": "ממאירות משניות",
            "section_type": "alert",
            "content": """⚠️ **סיכון מוגבר לסרטן נוסף**

**סוגי סרטן משניים:**
- לימפומות (בעיקר קשורות ל-EBV)
- סרטן עור (מלנומה, קרצינומה)
- סרטן פה ושפתיים
- MDS/AML משני
- גידולים מוצקים אחרים

**גורמי סיכון:**
- הקרנות כחלק מההכנה להשתלה
- דיכוי חיסוני ממושך
- זיהום EBV
- cGVHD

📅 **חשוב:** מעקב סרטן לכל החיים!""",
            "order_index": 14
        },
        {
            "title": "מעקב לאחר ההשתלה",
            "section_type": "text",
            "content": """**ניטור צמוד וממושך:**

מעקב אחר המטופל חיוני להצלחת ההשתלה ולאיתור מוקדם של סיבוכים:""",
            "order_index": 15
        },
        {
            "title": "מעקב המטולוגי",
            "section_type": "steps",
            "content": "בדיקות דם תקופתיות:",
            "metadata": {
                "steps": [
                    "**התאוששות שורות דם** - CBC מלא: Hb, WBC, Platelets",
                    "**תת קבוצות לימפוציטים** - CD4, CD8, CD19, NK cells",
                    "**Chimerism** - אחוז תאי התורם לעומת תאי הנתרם (100% = engraftment מלא)",
                    "**Minimal Residual Disease (MRD)** - בדיקה לשאריות מחלה (בלוקמיה/לימפומה)"
                ]
            },
            "order_index": 16
        },
        {
            "title": "סקירת זיהומים - ניטור ויראלי",
            "section_type": "list",
            "content": """**בדיקות PCR שגרתיות:**

🦠 **CMV (Cytomegalovirus)**
- הזיהום הנפוץ והמסוכן ביותר
- ניטור שבועי בחודשים הראשונים

🦠 **EBV (Epstein-Barr Virus)**
- סיכון ל-PTLD (Post-Transplant Lymphoproliferative Disease)

🦠 **Adenovirus**
- שכיח בילדים
- יכול לגרום לזיהומים מערכתיים חמורים

🦠 **BK Virus**
- פגיעה בכליות ובשלפוחית
- דימום בשתן (hemorrhagic cystitis)

🦠 **HHV6 (Human Herpesvirus 6)**
- זיהום CNS
- אנצפליטיס

💊 **טיפול מונחה PCR:** אם עלייה בעומס ויראלי - התחלה בטיפול ספציפי""",
            "order_index": 17
        },
        {
            "title": "טיפול פרופילקטי",
            "section_type": "options",
            "content": "מניעת זיהומים:",
            "metadata": {
                "options": [
                    {
                        "title": "אנטיביוטיקה פרופילקטית",
                        "description": "**רספרים (Bactrim/Septrin)** - מניעת PCP (Pneumocystis jirovecii). **פלואורוקינולונים** - מניעת זיהומים חיידקיים"
                    },
                    {
                        "title": "אנטי-ויראליים",
                        "description": "**אציקלוויר/ולציקלוביר** - מניעת HSV, VZV. **גנציקלוביר/ולגנציקלוביר** - במקרה של CMV"
                    },
                    {
                        "title": "אנטי-פטרייתיים",
                        "description": "**פלוקונזול/מיקפונגין/פוזקונזול** - מניעת זיהומי Candida ו-Aspergillus"
                    },
                    {
                        "title": "IVIG - אימונוגלובולינים",
                        "description": "תמיכה חיסונית עד התאוששות מערכת החיסון"
                    }
                ]
            },
            "order_index": 18
        },
        {
            "title": "נקודות מפתח",
            "section_type": "alert",
            "content": """📋 **סיכום השתלת מח עצם:**

✅ **טיפול מציל חיים:**
- פוטנציאל ריפוי מלוקמיה, לימפומה, המוגלובינופתיה ואחרים
- לרוב החולים יכולים לחזור לשגרה

⚠️ **סיבוכים בטווח קצר** (שנה ראשונה):
- **זיהומים** (CMV, EBV, Adenovirus, BK, HHV6)
- **SOS** - חסימת סינוסים בכבד
- **TA-TMA** - מיקרואנגיופתיה טרומבוטית
- **דלקת ריאות אינטרסטיציאלית**
- **aGVHD** - דלקת חריפה של השתל נגד המארח

⏰ **סיבוכים בטווח ארוך:**
- **cGVHD** - דלקת כרונית (דומה לאוטואימונית)
- הפרעות אנדוקריניות (גדילה, תירואיד, סוכרת)
- הפרעות נוירוקוגניטיביות
- ממאירות משניות

🔬 **מניעת cGVHD:**
דיכוי תאי T לפני השתלה (↓ התאמה = ↑ סיכון)

📊 **מעקב חיוני:**
- התאוששות שורות דם + תת קבוצות לימפוציטים
- Chimerism + MRD
- סקירת זיהומים: CMV, EBV, Adeno, BK, HHV6
- טיפול פרופילקטי: אנטיביוטיקה + אנטי-ויראליים + אנטי-פטרייתיים

💊 **הכנה להשתלה:**
כימותרפיה (Conditioning) למיגור מח עצם ודיכוי חיסון

🔑 **עיקרון מרכזי:** מעקב צמוד וטיפול מונחה PCR הם המפתח להצלחה!""",
            "order_index": 19
        }
    ]
    
    print(f"\n📑 מוסיף {len(sections)} מקטעים...")
    
    for idx, section in enumerate(sections, 1):
        section['topic_id'] = topic_id
        result = create_content_section(section)
        
        if result:
            print(f"  ✅ {idx}. {section['title']}")
        else:
            print(f"  ❌ {idx}. {section['title']} - נכשל")
    
    print("\n" + "="*60)
    print("✅ התוכן נוסף בהצלחה למסד הנתונים!")
    print("="*60)
    print(f"\n📊 סיכום:")
    print(f"   נושא: השתלת מח עצם - HCT")
    print(f"   קטגוריה: המטולוגיה/אונקולוגיה")
    print(f"   מקטעים: {len(sections)}")
    print(f"   ID: {topic_id}")
    
    return True

if __name__ == "__main__":
    print("🏥 PICU Learning Platform - הוספת תוכן")
    print("="*60)
    print("נושא: Hematopoietic Cell Transplantation (HCT)")
    print("="*60)
    
    try:
        success = add_hct_content()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - הגדרה ורקע")
            print("   - התוויות להשתלה")
            print("   - הכנה להשתלה")
            print("   - סיבוכים בטווח קצר (זיהומים, SOS, TMA, aGVHD)")
            print("   - סיבוכים בטווח ארוך (cGVHD, אנדוקריניים, קוגניטיביים)")
            print("   - מעקב ממושך וטיפול פרופילקטי")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
