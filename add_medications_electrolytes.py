#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: אלקטרוליטים (Electrolytes)
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_electrolytes():
    """הוספת תרופות אלקטרוליטים"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: אלקטרוליטים...")
    
    topic_data = {
        "title": "אלקטרוליטים - Electrolytes",
        "category": "medications",
        "description": "מדריך מקיף לתיקון אלקטרוליטים: אשלגן, מגנזיום, סידן, נתרן, סוכר",
        "icon": "⚡",
        "slug": "electrolytes",
        "tags": ["תרופות", "אלקטרוליטים", "אשלגן", "מגנזיום", "סידן", "נתרן", "סוכר", "גלוקוז"],
        "order_index": 4
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "אשלגן (פוטסיום) - Potassium",
            "section_type": "text",
            "content": """**Potassium - אשלגן / פוטסיום**

**תיאור:**
אלקטרוליט חיוני לתיפקוד תקין של תאים, שרירים, עצבים ולב

**ערכים תקינים:**
📊 **3.5-5.5 mEq/L**

---

**💉 תיקון היפוקלמיה (אשלגן נמוך):**

**עקרונות:**
- מהירות מתן מקסימלית: **0.5 mEq/kg/hour**
- ריכוז מקסימלי בווריד פריפרי: **40 mEq/L**
- ריכוז מקסימלי בווריד מרכזי: **150-200 mEq/L**

**מינון:**
💊 **0.5-1 mEq/kg/dose**
- PO (פומי): בדרך כלל **1-2 mEq/kg/day** חלוקה למנות
- IV (תוך ורידי): לפי חומרת ההיפוקלמיה

---

**📊 חישוב תיקון:**

**חוסר אשלגן (mEq) = (רצוי - ממצא) × משקל (ק"ג) × 0.4**

*0.4 = נפח חלוקה של אשלגן*

---

**⚠️ זהירות בהיפוקלמיה חמורה (<2.5):**

🚨 **יש לבדוק גם מגנזיום!**
- היפומגנזמיה מונעת תיקון אשלגן
- **חובה לתקן מגנזיום לפני/במקביל לתיקון אשלגן**

---

**⚡ מתי לתת IV מהר יותר:**

במצבים של:
- **אריתמיות לבביות**
- **חולשת שרירים משמעותית**
- **שיתוק נשימתי**

← ניתן לתת עד **0.5 mEq/kg/hour** תחת **ניטור קרדיאקי רציף**

---

**🚨 היפרקלמיה (אשלגן גבוה - >5.5):**

**טיפול חירום:**

1️⃣ **Calcium Gluconate 10%:**
💉 **100 mg/kg** (1 ml/kg) IV במשך **2-5 דקות**
- מגן על הלב, לא מוריד אשלגן
- תחילת פעולה: **1-3 דקות**
- משך: **30-60 דקות**

2️⃣ **Sodium Bicarbonate:**
💉 **1-2 mEq/kg** במשך **5-10 דקות**
- מעביר אשלגן לתוך התא
- יעיל בחמצת מטבולית

3️⃣ **Insulin + Glucose:**
💉 **0.1 units/kg Insulin** עם **0.5-1 g/kg Glucose**
- מעביר אשלגן לתוך התא
- תחילת פעולה: **15-30 דקות**
- משך: **4-6 שעות**

4️⃣ **Salbutamol (ונטולין) נבולייזר:**
💨 **0.15-0.3 mg/kg** (מקסימום 10 mg)
- מעביר אשלגן לתוך התא
- תחילת פעולה: **30 דקות**

5️⃣ **Kayexalate (תחליף אשלגן במעי):**
💊 **1 g/kg** PO/PR
- מסיר אשלגן מהגוף
- תחילת פעולה: **שעות**

6️⃣ **דיאליזה:**
- במקרים חמורים, אי-תגובה לטיפול, אי-ספיקת כליות

---

**⚠️ שימוש בזהירות:**

🚨 **אי-ספיקת כליות** - סיכון להיפרקלמיה
🚨 **תרופות חוסכות אשלגן** (Spironolactone, ACE-I, ARB)
🚨 **אקסטרווזציה** (דליפה מהוריד) ← נמק רקמות

---

**תופעות לוואי של תיקון מהיר:**

- **אריתמיות**
- כאב/צריבה במקום המתן
- בחילות, הקאות
- שלשול (PO)""",
            "order_index": 0
        },
        {
            "title": "מגנזיום - Magnesium",
            "section_type": "text",
            "content": """**Magnesium - מגנזיום**

**תיאור:**
אלקטרוליט חיוני לתיפקוד שרירים, עצבים, לב ועצמות

**ערכים תקינים:**
📊 **1.5-2.5 mEq/L** (או 1.8-3 mg/dL)

---

**💉 תיקון היפומגנזמיה:**

**Magnesium Sulfate 50%:**

**מינון רגיל:**
💉 **25-50 mg/kg/dose** IV
- מקסימום למנה: **2000 mg** (2 גרם)
- לתת במשך **30-60 דקות**
- ניתן לחזור כל **4-6 שעות**

**במצבי חירום (פרכוסים, אריתמיות):**
💉 **25-50 mg/kg** במשך **10-20 דקות**
- תחת ניטור קרדיאקי

---

**🎯 התוויות:**

✅ **היפומגנזמיה** (מגנזיום נמוך)
✅ **פרכוסים עקשניים** (במיוחד אם קשורים למגנזיום נמוך)
✅ **אריתמיות** (Torsades de Pointes, VT/VF עמיד)
✅ **אסטמה חמורה** (ברונכודילטציה)
✅ **פרה-אקלמפסיה/אקלמפסיה** (אמהות מניקות)

---

**💡 קשר למינרלים אחרים:**

🔗 **מגנזיום נמוך ← אי-יכולת לתקן:**
- **היפוקלמיה** (אשלגן נמוך)
- **היפוקלצמיה** (סידן נמוך)

💎 **חובה לבדוק ולתקן מגנזיום בכל מקרה של אשלגן או סידן נמוכים עקשניים!**

---

**⚠️ זהירות:**

🚨 **מתן מהיר מדי** ← היפוטנסיה, ברדיקרדיה
🚨 **אי-ספיקת כליות** ← סיכון להיפרמגנזמיה
🚨 **חסימות לב** (AV Block) ← עלול להחמיר

---

**🚨 היפרמגנזמיה (>2.5 mEq/L):**

**סימנים:**
- >4 mEq/L: אובדן רפלקסים עמוקים
- >5 mEq/L: הרחבת QRS, ירידת לחץ דם
- >7 mEq/L: שיתוק נשימתי, דום לב

**טיפול:**
1️⃣ **Calcium Gluconate 10%:** 100 mg/kg IV (אנטידוט)
2️⃣ **נוזלים + פורוזמיד** (אם תיפקוד כליות תקין)
3️⃣ **דיאליזה** (מקרים חמורים)

---

**תופעות לוואי:**

**קרדיווסקולריות:**
- **היפוטנסיה** (במתן מהיר)
- **ברדיקרדיה**
- הרחבת QRS

**נוירולוגיות:**
- ישנוניות
- אובדן רפלקסים עמוקים
- בלבול

**אחרות:**
- חום/גרד במקום המתן
- בחילות
- הזעה

---

**💡 מינון באסטמה חריפה:**

💉 **25-75 mg/kg/dose** IV במשך **20 דקות**
- מקסימום: **2 גרם**
- יעיל באסטמה חמורה שאינה מגיבה לטיפול סטנדרטי""",
            "order_index": 1
        },
        {
            "title": "סידן (קלציום) - Calcium",
            "section_type": "text",
            "content": """**Calcium - סידן / קלציום**

**תיאור:**
אלקטרוליט חיוני לתיפקוד לב, שרירים, עצבים, קרישת דם ובניית עצמות

**ערכים תקינים:**
📊 **Total Calcium: 8.5-10.5 mg/dL**
📊 **Ionized Calcium: 4.5-5.5 mg/dL (1.1-1.4 mmol/L)**

---

**💉 Calcium Gluconate 10% (גלוקונט קלציום):**

**מינון טיפולי:**
💉 **100 mg/kg/dose** (= 1 ml/kg)
- מקסימום למנה: **2000 mg** (20 ml)
- לתת במשך **5-10 דקות**
- תחת **ניטור קרדיאקי**

**מתן מתמשך:**
💧 **200-500 mg/kg/day**
- חלוקה למתן רציף

---

**🎯 התוויות:**

✅ **היפוקלצמיה סימפטומטית** (עוויתות, טטניה, פרכוסים)
✅ **היפרקלמיה** (הגנה על הלב)
✅ **היפרמגנזמיה** (אנטידוט)
✅ **חסימת תעלות סידן** (הרעלת Ca-blockers)
✅ **הלם ספטי** (במקרי היפוקלצמיה)

---

**💡 Calcium Gluconate vs Calcium Chloride:**

**Calcium Gluconate 10%:**
- 1 ml = **9 mg elemental calcium**
- **פחות מגרה** לוורידים
- **בחירה בילדים** (פריפריים)

**Calcium Chloride 10%:**
- 1 ml = **27 mg elemental calcium** (פי 3!)
- **מגרה מאוד** לוורידים
- רק ב**צנתר מרכזי** או **החייאה**
- מינון: **20 mg/kg** (0.2 ml/kg)

---

**⚠️ זהירות חמורה:**

🚨 **אקסטרווזציה** (דליפה מהוריד) ← **נמק רקמות חמור!**
🚨 **לשטוף את הווריד לפני ואחרי** (גורם לקרישת דם/משקעים)
🚨 **אסור לערבב עם ביקרבונט** ← משקעים

---

**⚠️ זהירות בדיגיטליס:**

🚨 חולים על **דיגוקסין/דיגיטליס**:
- סידן מגביר רעילות דיגיטליס
- סיכון לאריתמיות חמורות
- לתת **לאט מאוד** (**20-30 דקות**)
- ניטור קרדיאקי הדוק

---

**🚨 היפרקלצמיה (>10.5 mg/dL):**

**סימנים:**
- בחילות, הקאות, עצירות
- חולשה שרירים
- בלבול, שינויים נפשיים
- קיצור QT
- אריתמיות

**טיפול:**
1️⃣ **נוזלים** (NS להידרציה)
2️⃣ **Furosemide** (משתן)
3️⃣ **סטרואידים** (בהיפרקלצמיה ממאירות)
4️⃣ **Calcitonin** (במקרים חמורים)
5️⃣ **דיאליזה** (מקרים קיצוניים)

---

**תופעות לוואי:**

**קרדיווסקולריות:**
- **ברדיקרדיה** (במתן מהיר)
- **אריתמיות** (במיוחד על דיגיטליס)
- היפוטנסיה

**מקומיות:**
- **נמק רקמות** (אקסטרווזציה)
- צריבה/כאב במקום המתן

**אחרות:**
- טעם מתכתי בפה
- חום, הזעה
- בחילות

---

**💡 פרמקולוגיה:**

**תחילת פעולה:**
- IV: **מיידית**

**משך השפעה:**
- **30-60 דקות** (סידן יוני)
- **2-3 שעות** (סידן כללי)""",
            "order_index": 2
        },
        {
            "title": "נתרן - Sodium (תיקון הפרעות)",
            "section_type": "text",
            "content": """**Sodium - נתרן**

**ערכים תקינים:**
📊 **135-145 mEq/L**

---

**💉 Sodium Bicarbonate (נתרן ביקרבונט):**

**שימושים:**
✅ **חמצת מטבולית** (pH נמוך)
✅ **היפרקלמיה** (אשלגן גבוה)
✅ **הרעלת תרופות תלויות pH** (TCA, אספירין)
✅ **החייאה** (במצבים מסוימים)

**מינון:**
💉 **1 mEq/kg/dose** IV
- **לדלל פי 2 בילדים מתחת לגיל שנתיים**
- לתת לאט (10-20 דקות)

**חישוב חוסר בסיסים:**
**Base Deficit = 0.3 × משקל (ק"ג) × (24 - HCO₃ הנמדד)**
- לתת **חצי** מהחוסר, לבדוק גזים חוזר

---

**💧 Hypertonic Saline 3% (מלח היפרטוני):**

**שימושים:**
✅ **היפונתרמיה חמורה סימפטומטית** (<120, פרכוסים, קומה)
✅ **הפחתת ICP** (במקום/בנוסף למניטול)
✅ **טראומת ראש**

**מינון להיפונתרמיה חריפה:**
💉 **2-5 ml/kg** של 3% במשך **10-20 דקות**
- יעד: העלאת נתרן ב-**3-5 mEq/L** בשעות הראשונות
- מקסימום עליה: **10-12 mEq/L ביום הראשון**

⚠️ **סכנה:** עליה מהירה מדי ← **Central Pontine Myelinolysis**

**מינון להורדת ICP:**
💉 **5 ml/kg** של 3% במשך **10-20 דקות**
- יעיל להורדת לחץ תוך גולגולתי

---

**📊 חישוב תיקון נתרן:**

**חוסר נתרן (mEq) = (רצוי - ממצא) × משקל (ק"ג) × 0.6**

*0.6 = נפח חלוקה של נתרן*

**מהירות תיקון מקסימלית:**
🚨 **0.5 mEq/L/hour** (לא יותר!)
🚨 **10-12 mEq/L ביום הראשון**

---

**🚨 היפונתרמיה (<135):**

**חמורה (<120) + סימפטומטית:**
- פרכוסים, קומה, בלבול
- טיפול: **3% Hypertonic Saline**
- מהירות: **3-5 mEq/L בשעות ראשונות**, אח"כ לאט

**כרונית/אסימפטומטית:**
- הגבלת נוזלים
- תיקון איטי
- טיפול בגורם (SIADH, אי-ספיקת לב, כליות)

---

**🚨 היפרנתרמיה (>145):**

**טיפול:**
🚰 **הידרציה איטית**
- מהירות ירידה מקסימלית: **0.5 mEq/L/hour**
- **10-12 mEq/L ביום**

**חישוב חוסר מים חופשיים:**
**Water Deficit = 4 × משקל (ק"ג) × (נתרן נמדד - 140) / 140**

**תמיסה:**
- D5W או 0.45% NS
- איטי על פני 48-72 שעות

⚠️ **סכנה:** ירידה מהירה מדי ← בצקת מוחית

---

**⚠️ זהירות:**

🚨 **ביקרבונט:** אסור לערבב עם סידן (משקעים)
🚨 **3% Saline:** ניטור נתרן כל 2-4 שעות
🚨 **תיקון מהיר מדי:** Central Pontine Myelinolysis (CPM)""",
            "order_index": 3
        },
        {
            "title": "גלוקוז (סוכר) - Glucose",
            "section_type": "text",
            "content": """**Glucose - גלוקוז / סוכר**

**ערכים תקינים:**
📊 **70-100 mg/dL** (צום)
📊 **<140 mg/dL** (אחרי אוכל)

---

**💉 טיפול בהיפוגליקמיה (סוכר נמוך):**

**הגדרה:**
- **ילודים:** <40-45 mg/dL
- **ילדים:** <60-70 mg/dL

---

**📊 מינון חירום (כשיש סימפטומים):**

**Dextrose 10% (D10):**
💉 **2-5 ml/kg** IV במשך **2-3 דקות**
- = **200-500 mg/kg** של גלוקוז

**או Dextrose 25% (D25) במתבגרים:**
💉 **1-2 ml/kg** IV
- לדלל פי 2-4 לפני מתן בילדים קטנים

⚠️ **אסור D50 בילדים!** (היפראוסמולרי מדי, נמק רקמות)

---

**🍬 גלוקגון - Glucagon:**

**במקרים שאין גישה ורידית:**
💉 **IM/SC:** 0.5-1 mg
- **<20 ק"ג:** 0.5 mg (או 0.02-0.03 mg/kg)
- **>20 ק"ג:** 1 mg

**מנגנון:**
משחרר גלוקוז מהכבד (גליקוגנוליזה)

⚠️ **לא יעיל במצבים של:**
- מחסור בגליקוגן (תת-תזונה, מחלות אגירה)
- אי-ספיקת כבד
- הרעלת אלכוהול

---

**💧 מתן מתמשך (לאחר תיקון חירום):**

**Glucose Infusion Rate (GIR):**

**חישוב GIR:**
**GIR (mg/kg/min) = (% Dextrose × קצב עירוי ml/hour) / (6 × משקל בק"ג)**

**יעדים:**
- **ילודים:** 4-8 mg/kg/min
- **תינוקות:** 4-6 mg/kg/min
- **ילדים:** 2-4 mg/kg/min

---

**📊 טיפוסי עירויים:**

**D5 (5%):** תחזוקה רגילה
**D10 (10%):** היפוגליקמיה חוזרת, ילודים
**D12.5-D15:** מקרים קשים של היפוגליקמיה

---

**🚨 היפרגליקמיה (סוכר גבוה):**

**סיבות נפוצות ב-PICU:**
- מתח/סטרס
- סטרואידים
- סוכרת
- עירוי גלוקוז מהיר מדי
- DKA

**טיפול:**
1️⃣ **Insulin (אינסולין):**
💉 **0.05-0.1 units/kg/hour** IV
- בדרך כלל מתחילים רק מעל **200 mg/dL**

2️⃣ **הידרציה**

3️⃣ **טיפול בגורם**

---

**⚠️ זהירות במתן גלוקוז:**

🚨 **אקסטרווזציה** - גלוקוז מרוכז (>12.5%) גורם לנמק רקמות
🚨 **היפרגליקמיה** - קשורה לתוצאות גרועות ב-TBI וב-sepsis
🚨 **Rebound hypoglycemia** - אם מפסיקים עירוי מהיר פתאום

---

**💡 ניטור:**

בהיפוגליקמיה:
- בדיקת סוכר כל **15-30 דקות** עד לייצוב
- אחר כך כל **1-2 שעות**
- ניטור רציף (CGM) אם זמין

---

**תופעות לוואי:**

**מקומיות:**
- פלביטיס (דלקת ורידים)
- נמק רקמות (אקסטרווזציה)

**מערכתיות:**
- היפרגליקמיה
- דילול אלקטרוליטים (במתן מהיר של נפחים גדולים)
- דיאורזה אוסמוטית (במתן מרוכז)""",
            "order_index": 4
        },
        {
            "title": "נקודות מפתח - אלקטרוליטים",
            "section_type": "text",
            "content": """**🎯 נקודות מפתח:**

✅ **אשלגן:** 0.5-1 mEq/kg, מקסימום 0.5 mEq/kg/hour. בדוק מגנזיום אם עקשני!

✅ **מגנזיום:** 25-50 mg/kg (מקס 2 גרם), במשך 30-60 דקות. חיוני לתיקון K ו-Ca

✅ **סידן גלוקונט:** 100 mg/kg (1 ml/kg), תחת ניטור. שטוף לפני ואחרי!

✅ **3% Hypertonic Saline:** 2-5 ml/kg להיפונתרמיה, 5 ml/kg להורדת ICP

✅ **ביקרבונט:** 1 mEq/kg. דלל פי 2 מתחת לגיל 2. אסור לערבב עם סידן!

✅ **D10 (היפוגליקמיה):** 2-5 ml/kg. אסור D50 בילדים!

✅ **גלוקגון:** 0.5 mg (<20 ק"ג) או 1 mg (>20 ק"ג) IM כשאין גישה ורידית

✅ **מהירות תיקון נתרן:** מקסימום 0.5 mEq/L/hour, 10-12 mEq/L ביום ראשון""",
            "order_index": 5
        },
        {
            "title": "אזהרות קריטיות",
            "section_type": "text",
            "content": """**🚨 אזהרות חשובות:**

🔴 **תיקון נתרן מהיר מדי:** Central Pontine Myelinolysis (CPM) - נזק מוחי בלתי הפיך!

🔴 **סידן אקסטרווזציה:** נמק רקמות חמור! לשטוף לפני ואחרי. אסור לערבב עם ביקרבונט

🔴 **סידן בדיגיטליס:** רעילות חמורה! לתת לאט מאוד (20-30 דקות) עם ניטור הדוק

🔴 **היפוקלמיה עקשנית:** תמיד בדוק מגנזיום! לא ניתן לתקן אשלגן ללא מגנזיום

🔴 **מגנזיום מהיר:** היפוטנסיה + ברדיקרדיה. במצבי חירום - ניטור קרדיאקי!

🔴 **D50 בילדים:** אסור! היפראוסמולרי ← נמק רקמות. השתמש D10 או D25 מדולל

🔴 **אשלגן מהיר:** מקסימום 0.5 mEq/kg/hour. מהר יותר ← אריתמיות קטלניות

🔴 **גלוקוז מרוכז (>12.5%):** רק בצנתר מרכזי. פריפרי ← נמק רקמות""",
            "order_index": 6
        },
        {
            "title": "פנינים קליניות",
            "section_type": "text",
            "content": """**💎 פנינים קליניות:**

💎 **טריאדת אלקטרוליטים:** K-Mg-Ca תלויים זה בזה. מגנזיום נמוך ← לא ניתן לתקן אשלגן וסידן

💎 **היפרקלמיה חירום:** סדר עדיפויות - Ca-gluconate קודם (מגן על הלב), אחר כך מעבירים פנימה

💎 **3% Saline ב-TBI:** יעיל להורדת ICP, יותר מניטול במצבים מסוימים

💎 **היפונתרמיה:** ACUTE (<48h) - אפשר לתקן מהר יותר. CHRONIC - איטי בלבד!

💎 **תיקון אשלגן:** עדיף PO אם המטופל יציב (איטי יותר, בטוח יותר, נספג טוב)

💎 **Calcium Chloride vs Gluconate:** CaCl₂ פי 3 יותר חזק אבל מגרה מאוד. רק בצנתר מרכזי

💎 **מגנזיום באסטמה:** 25-75 mg/kg יעיל באסטמה חמורה שלא מגיבה לסלבוטמול

💎 **גלוקגון:** לא עובד במחסור גליקוגן (רעב, מחלות אגירה), אי-ספיקת כבד, אלכוהול

💎 **Rebound hypoglycemia:** הפסקת גלוקוז פתאומית ← סוכר צולל. גמילה הדרגתית!

💎 **ביקרבונט בהחייאה:** לא שגרתי! רק אחרי החייאה ממושכת או היפרקלמיה ידועה

💎 **אשלגן בווריד:** ריכוז מקסימלי פריפרי 40 mEq/L, מרכזי 150-200 mEq/L

💎 **ניטור נתרן:** בתיקון 3% - בדיקה כל 2-4 שעות. יעד 3-5 mEq עליה בשעות ראשונות""",
            "order_index": 7
        }
    ]
    
    # הוספת כל המקטעים
    print(f"\n📚 מוסיף {len(sections)} מקטעים...")
    
    for idx, section_data in enumerate(sections, 1):
        section_data['topic_id'] = topic_id
        
        section = create_content_section(section_data)
        
        if section:
            print(f"   ✅ מקטע {idx}/{len(sections)}: {section_data['title']}")
        else:
            print(f"   ❌ שגיאה במקטע {idx}: {section_data['title']}")
            return False
    
    return True

if __name__ == "__main__":
    print("="*60)
    print("⚡ הוספת תוכן: אלקטרוליטים")
    print("="*60)
    
    try:
        success = add_electrolytes()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - אשלגן (Potassium)")
            print("   - מגנזיום (Magnesium)")
            print("   - סידן (Calcium)")
            print("   - נתרן (Sodium)")
            print("   - גלוקוז (Glucose)")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
