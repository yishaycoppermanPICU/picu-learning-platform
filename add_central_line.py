#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: צנתר מרכזי לטווח ארוך
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_central_line_content():
    """הוספת נושא צנתרים מרכזיים עם כל המקטעים"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: צנתר מרכזי לטווח ארוך...")
    
    topic_data = {
        "title": "צנתר מרכזי לטווח ארוך",
        "category": "monitoring",
        "description": "סוגי צנתרים מרכזיים, התוויות, והנחיות תחזוקה",
        "icon": "💉",
        "slug": "central_venous_catheter_long_term",
        "tags": ["ניטור", "צנתרים", "CVC", "PICC", "Hickman", "Port", "נהלים"],
        "order_index": 70
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "הגדרה - צנתרים מרכזיים",
            "section_type": "text",
            "content": """**Central Venous Catheters - גישה ורידית מרכזית**

צנתרים המוחדרים לוורידים מרכזיים לטווח בינוני-ארוך, לצורכי טיפול ומעקב.

**שלוש קבוצות עיקריות:**

1️⃣ **מושתלים לחלוטין:**
   - Implant Mediport
   - Port-a-Cath

2️⃣ **עם תעלה תת-עורית (Tunneled):**
   - Hickman
   - Permacath
   - Broviac

3️⃣ **ללא תעלה (Non-tunneled):**
   - PICC (Peripherally Inserted Central Catheter)
   - CVC (Central Venous Catheter)""",
            "order_index": 0
        },
        {
            "title": "CVC - Central Venous Catheter",
            "section_type": "text",
            "content": """**צנתר ורידי מרכזי ללא תעלה**

הצנתר הנפוץ ביותר בטיפול נמרץ לטווח קצר-בינוני.""",
            "order_index": 1
        },
        {
            "title": "מיקומי החדרה של CVC",
            "section_type": "options",
            "content": "אתרי החדרה אפשריים:",
            "metadata": {
                "options": [
                    {
                        "title": "Subclavian (סאב-קלאביאן) - מועדף ✅",
                        "description": "מתחת לעצם הבריח. **יתרונות:** נוח למטופל, שיעור זיהומים נמוך, קיבוע יציב"
                    },
                    {
                        "title": "Internal Jugular (ג'וגולר פנימי) - מועדף ✅",
                        "description": "בצוואר. **יתרונות:** נגיש, קל להחדרה, פחות סיכונים"
                    },
                    {
                        "title": "Femoral (פמורלי) - לא מומלץ ⚠️",
                        "description": "בוריד הירך. **חסרונות:** חשש מוגבר לזיהום, מגביל תנועה",
                        "indication": "רק במצבי חירום או כאשר לא ניתן להשתמש באתרים אחרים"
                    }
                ]
            },
            "order_index": 2
        },
        {
            "title": "מאפייני CVC",
            "section_type": "list",
            "content": """**פרטים טכניים:**

📍 **מיקום קצה הצנתר:**
- בהחדרה ל-Jugular או Subclavian → עד **חדר ימין של הלב** (או SVC)

🔒 **קיבוע:**
- בתפירה לעור

⏰ **משך שימוש:**
- עד **6 שבועות** מקסימום
- ככל שארוך יותר → סיכון גבוה יותר לזיהום

📊 **נתיבים:**
- 1-4 lumens (בדרך כלל 3)""",
            "order_index": 3
        },
        {
            "title": "התוויות ל-CVC",
            "section_type": "steps",
            "content": "מתי צריך צנתר מרכזי?",
            "metadata": {
                "steps": [
                    "**קושי בהחדרת עירוי פריפרי** - וורידים גרועים, ניסיונות כושלים חוזרים",
                    "**נוזלים היפר-אוסמולאריים** - TPN, תמיסות ריכוז גבוה",
                    "**תרופות חומציות או בסיסיות** - שיכולות לגרום לנזק לווריד פריפרי",
                    "**מורכבות גבוהה** - מספר תרופות בו-זמנית, זקוקים למספר נתיבים",
                    "**גישה ורידית ממושכת** - צפי לטיפול ארוך, לא מתאים לצנתר ארוך טווח",
                    "**ניטור CVP** - מדידת לחץ ורידי מרכזי (Central Venous Pressure)"
                ]
            },
            "order_index": 4
        },
        {
            "title": "PICC - Peripherally Inserted Central Catheter",
            "section_type": "text",
            "content": """**צנתר מרכזי המוחדר דרך וריד פריפרי**

**הגדרה:**
צנתר ארוך המוחדר מוריד פריפרי (לרוב בזרוע) ומגיע עד לווריד מרכזי.

**מאפיינים:**
- 📏 **אתר החדרה:** וריד בזרוע (Basilic/Cephalic)
- 📍 **קצה הצנתר:** מגיע עד ה-SVC (Superior Vena Cava)
- ⏰ **משך שימוש:** 3-12 חודשים
- 📊 **נתיבים:** 1-2
- 🔒 **קיבוע:** Securement device + חבישה

**יתרונות:**
✅ אין צורך בהחדרה כירורגית
✅ פחות סיכונים מ-CVC (אין פנאומותורקס)
✅ נוח למטופל
✅ מתאים לטיפול ממושך בבית

**חסרונות:**
❌ מוגבל ל-1-2 נתיבים
❌ עלול להיתקע או להידבק""",
            "order_index": 5
        },
        {
            "title": "Hickman - היקמן",
            "section_type": "text",
            "content": """**צנתר המוחדר לווריד מרכזי דרך תעלה תת-עורית (Tunneled)**

**הגדרה:**
צנתר עם תעלה תת-עורית שמפחיתה סיכון לזיהום ומאפשרת שימוש ארוך טווח.""",
            "order_index": 6
        },
        {
            "title": "מאפיינים טכניים - Hickman",
            "section_type": "list",
            "content": """**פרטי צנתר:**

📏 **אורך:** 35-100 ס"מ (תלוי בגודל המטופל)

📐 **קוטר (French):** 2.7-12.5 Fr

📊 **נתיבים:** 1-3 lumens

💧 **קיבולת נפח:** 0.15-2 מ"ל (לכל lumen)

🧵 **Dacron Cuff:** חלק מרקם המאפשר צמיחת רקמה לתוכו לקיבוע""",
            "order_index": 7
        },
        {
            "title": "התוויות ל-Hickman",
            "section_type": "list",
            "content": """**שימושים מרכזיים:**

🎗️ **מטופלים המטו-אונקולוגים:**
- כימותרפיה ממושכת
- השתלת מח עצם ותאי אב
- טיפולים ביולוגיים

💉 **טיפול ורידי ארוך טווח:**
- TPN (תזונה פרנטרלית) ממושכת
- אנטיביוטיקה IV ארוכת טווח
- עירויים תכופים

📊 **דגימות דם חוזרות:**
- חוסך דקירות חוזרות
- נוח במיוחד לילדים""",
            "order_index": 8
        },
        {
            "title": "Port-a-Cath (פורט)",
            "section_type": "text",
            "content": """**צנתר מושתל לחלוטין תחת העור**

**מבנה:**
- **הצנתר:** מגיע עד לווריד מרכזי (SVC) או לעלייה הימנית של הלב
- **הקופסית (Chamber):** מושתלת מתחת לעור, בד"כ בחזה
- **הממברנה (Septum):** דסקית סיליקון העמידה לאלפי דקירות

**יתרונות:**
✅ אין חלק חיצוני - אסתטי, נוח
✅ פחות סיכון לזיהום
✅ ניתן לשחות, להתקלח
✅ משך שימוש: שנים רבות

**חסרונות:**
❌ צריך דקירה בכל שימוש
❌ דורש מחט מיוחדת (Huber needle)
❌ החדרה והסרה כירורגיות""",
            "order_index": 9
        },
        {
            "title": "עקרונות הטיפול בפורט",
            "section_type": "steps",
            "content": "הנחיות לשימוש ותחזוקה:",
            "metadata": {
                "steps": [
                    "**הוצאת תפרים:** 7-10 ימים מההחדרה הכירורגית",
                    "**שטיפת הפורט:** כל 6-8 שבועות (גם כשלא בשימוש!) עם Heparin",
                    "**טיפול במחט:** יש להימנע מטלטול המחט - עלול לגרום לנזק לממברנה או לכאב",
                    "**אימות מיקום:** חשוב לוודא חזרת דם טרם קיבוע המחט - מאשר מיקום נכון",
                    "**החלפת מחט Huber:** כל 7 ימים בשימוש רצוף"
                ]
            },
            "order_index": 10
        },
        {
            "title": "החלפת חבישות - עקרונות כלליים",
            "section_type": "text",
            "content": """**חשיבות החלפת חבישות:**
מניעת זיהומים, ניטור אתר ההחדרה, שמירה על קיבוע.

**שני סוגי חבישות:**
1. **חבישה אטומה (גזה + פד)** - כשיש הפרשה או דימום
2. **חבישה שקופה (Tegaderm)** - מאפשרת תצפית על האתר""",
            "order_index": 11
        },
        {
            "title": "צנתר פריפרי - החלפת חבישה",
            "section_type": "list",
            "content": """**פרוטוקול לצנתר פריפרי:**

🧤 **טכניקה:** אספטית עם כפפות (לא סטריליות)

📋 **חבישה אטומה (פד גזה):**
- החלפה כל **48 שעות**
- או מיד אם רטובה/מלוכלכת

📋 **חבישה שקופה חצי נושמת (Tegaderm):**
- החלפה כל **3-7 ימים**
- או מיד אם מתקלפת/לא שקופה

📝 **תיעוד:**
החלפת החבישה תתועד ברשומה הרפואית (תאריך, שעה, מצב האתר)""",
            "order_index": 12
        },
        {
            "title": "צנתר מרכזי - החלפת חבישה",
            "section_type": "alert",
            "content": """⚠️ **טכניקה אספטית מלאה - חובה!**

**פרוטוקול מחמיר יותר:**

🧼 **הכנה:**
- חיטוי ידיים
- כפפות **סטריליות**
- חיטוי העור (Chlorhexidine 2%)

📋 **החלפת חבישה ראשונית:**
- לאחר **24 שעות** מההחדרה

📋 **חבישה שקופה:**
- החלפה כל **5-7 ימים**
- או מיד במקרה של לכלוך/רטיבות

💡 **למה כל כך קפדני?** צנתר מרכזי = ישירות ללב → סיכון גבוה לזיהום דם (bacteremia)""",
            "order_index": 13
        },
        {
            "title": "החלפת ציוד - טבלת זמנים",
            "section_type": "text",
            "content": """**לוח זמנים מקיף להחלפת ציוד:**

| **פריט** | **בשימוש רציף** | **ללא שימוש/לא רציף** | **הערות** |
|----------|-----------------|----------------------|-----------|
| **ונטיל (Cap)** | 96 שעות (4 ימים) | 7 ימים | לסגור תמיד! |
| **סט עירוי רגיל** | 96 שעות (4 ימים) | 24 שעות | שימוש לא רציף = יותר תכוף |
| **סט עם דם** | 24 שעות | לאחר סיום מיד | זיהום מהיר! |
| **סט פרופופול** | 6-12 שעות | - | במחלקה: 6 שעות (מדיום לחיידקים) |
| **פגים < 2 חודשים** | 24 שעות | 24 שעות | החלפה של הכל: סט, ברזים, ונטילים |

📅 **כלל אצבע:**
- ככל שהתכולה יותר "מזינה" (דם, שומנים) → החלפה תכופה יותר
- פגים ותינוקות → קפדנות מוגברת""",
            "order_index": 14
        },
        {
            "title": "נקודות מפתח",
            "section_type": "alert",
            "content": """📋 **סיכום צנתרים מרכזיים:**

🏥 **סוגי צנתרים:**

**CVC** - קצר טווח (עד 6 שבועות)
- מיקומים מועדפים: Subclavian, Jugular
- ❌ הימנע מ-Femoral (זיהום!)
- התוויות: טיפול נמרץ, CVP, נוזלים מיוחדים

**PICC** - בינוני-ארוך (3-12 חודשים)
- מוחדר מזרוע, מגיע ל-SVC
- 1-2 נתיבים
- מתאים לטיפול ממושך, גם בבית

**Hickman** - ארוך טווח (חודשים-שנים)
- עם תעלה תת-עורית
- 1-3 נתיבים, 35-100 ס"מ
- מושתלי מח עצם, המטו-אונקו

**Port-a-Cath** - ארוך מאוד (שנים)
- מושתל לחלוטין תחת העור
- שטיפה כל 6-8 שבועות
- מחט Huber מיוחדת

🧼 **החלפת חבישות:**

**פריפרי:**
- אספטי (לא סטרילי)
- גזה: 48 שעות
- שקוף: 3-7 ימים

**מרכזי:**
- אספטי מלא + כפפות סטריליות
- ראשונה: 24 שעות
- שקוף: 5-7 ימים

⏰ **החלפת ציוד:**
- ונטיל: 96 שעות (רציף) / 7 ימים (לא בשימוש)
- סט: 96 שעות (רציף) / 24 שעות (לא רציף)
- דם: 24 שעות מקסימום
- פרופופול: 6-12 שעות (במחלקה: 6)
- פגים: הכל כל 24 שעות!

🔑 **עיקרון זהב:** צנתר נקי = מטופל בטוח!""",
            "order_index": 15
        }
    ]
    
    print(f"\n📑 מוסיף {len(sections)} מקטעים...")
    
    for idx, section in enumerate(sections, 1):
        section['topic_id'] = topic_id
        result = create_content_section(section)
        
        if result:
            print(f"  ✅ {idx}. {section['title']}")
        else:
            print(f"  ❌ {idx}. {section['title']} - נכשל")
    
    print("\n" + "="*60)
    print("✅ התוכן נוסף בהצלחה למסד הנתונים!")
    print("="*60)
    print(f"\n📊 סיכום:")
    print(f"   נושא: צנתר מרכזי לטווח ארוך")
    print(f"   קטגוריה: ניטור ונהלים")
    print(f"   מקטעים: {len(sections)}")
    print(f"   ID: {topic_id}")
    
    return True

if __name__ == "__main__":
    print("💉 PICU Learning Platform - הוספת תוכן")
    print("="*60)
    print("נושא: צנתר מרכזי לטווח ארוך")
    print("="*60)
    
    try:
        success = add_central_line_content()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - הגדרות וסוגי צנתרים")
            print("   - CVC - מיקומים והתוויות")
            print("   - PICC - מאפיינים ושימושים")
            print("   - Hickman - פרטים טכניים")
            print("   - Port-a-Cath - עקרונות שימוש")
            print("   - החלפת חבישות ותחזוקה")
            print("   - טבלת זמנים להחלפת ציוד")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
