#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: Tumor Lysis Syndrome (TLS)
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_tls_content():
    """הוספת נושא TLS עם כל המקטעים"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: Tumor Lysis Syndrome...")
    
    topic_data = {
        "title": "Tumor Lysis Syndrome - TLS",
        "category": "hematology",
        "description": "מצב חירום אונקולוגי מסכן חיים - מניעה, אבחון וטיפול",
        "icon": "⚠️",
        "slug": "tumor_lysis_syndrome",
        "tags": ["המטולוגיה", "אונקולוגיה", "TLS", "חירום", "כליות", "אלקטרוליטים"],
        "order_index": 50
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "הגדרה - Tumor Lysis Syndrome",
            "section_type": "text",
            "content": """**מצב חירום אונקולוגי**

TLS נגרם ממסה של **פירוק תאים** המשחררים לזרם הדם:
- **פוטסיום** (K⁺)
- **פוספט** (PO₄³⁻)
- **חומצות גרעין**

**התהליך הפתופיזיולוגי:**
פירוק חומצות הגרעין → **היפר אוריצמיה** (uric acid ↑)

⚠️ **מסכן חיים!**""",
            "order_index": 0
        },
        {
            "title": "פתופיזיולוגיה - הפגיעה הכלייתית",
            "section_type": "text",
            "content": """חומצה אורית (uric acid) גורמת ל:

1. **משקעים בכליות**
2. **וואזוקונסטריקציה**
3. **פגיעה בוויסות האוטומטי של הכליות**
4. **ירידה בסינון הכלייתי** (GFR ↓)
5. **חמצון ודלקת**

→ **Acute Kidney Injury (AKI)**

💡 **גורם מחמיר:**
היפרפוספטמיה + היפוקלצמיה → משקעי קלציום-פוספט

⚡ **סינרגיה מסוכנת:**
חומצה אורית + קלציום פוספט = משקעים מהירים בכליות""",
            "order_index": 1
        },
        {
            "title": "מתי מתרחש TLS?",
            "section_type": "list",
            "content": """**גורמי סיכון:**

🎗️ **לאחר טיפול כימוטרפי** (הנפוץ ביותר)
- לימפומות
- **ALL (Acute Lymphoblastic Leukemia)** - בייחוד!

🔬 **סוגי סרטן אחרים:**
- עם או בלי טיפול כימוטרפי מקדים

📈 **מגמה עולה:**
השימוש בטיפולים אנטי-סרטניים חדשים בשילוב עם תרופות ציטוטוקסיות קונבנציונליות → עלייה משמעותית במקרים של TLS

⚠️ **חשוב:** TLS יכול להופיע **ספונטנית** ללא טיפול כימוטרפי!""",
            "order_index": 2
        },
        {
            "title": "אבחנה",
            "section_type": "text",
            "content": """TLS מאובחנת על ידי:

1. **ממצאי מעבדה:**
   - ↑ Potassium (K⁺)
   - ↑ Phosphate (PO₄³⁻)
   - ↑ Uric Acid
   - ↓ Calcium (Ca²⁺)
   - ↑ Creatinine (פגיעה כלייתית)

2. **ממצאים קליניים:**
   - סימני פגיעה כלייתית
   - הפרעות קצב
   - שינויים נוירולוגיים""",
            "order_index": 3
        },
        {
            "title": "מניעה של TLS",
            "section_type": "text",
            "content": """שלושה עמודי התווך של מניעה:""",
            "order_index": 4
        },
        {
            "title": "1. הידרציה",
            "section_type": "text",
            "content": """**מטרה:** לשטוף את הכליות ולמנוע משקעים

**פרוטוקול:**
- נוזלים IV אגרסיביים
- ניטור תפוקת שתן
- יעד: תפוקה גבוהה של שתן

⚠️ **זהירות באי ספיקת לב:**
- הזרמה איטית
- ניטור צמוד
- משתנים לפי צורך""",
            "order_index": 5
        },
        {
            "title": "2. אלופרינול (Allopurinol)",
            "section_type": "text",
            "content": """**מנגנון פעולה:**
מונע **ייצור** של חומצה אורית חדשה

**יעילות:**
✅ מצוין למניעה
❌ לא יעיל כשה-TLS כבר פעיל (כי יש כבר חומצה אורית מהתאים שעברו ליזיס)

⚠️ **אזהרה - אינטראקציות:**
- ציקלופוספמיד
- מתוטרקסט
- אמפיצילין / אמוקסיצילין
- קרבמזפין
- משתני לולאה ותיאזידים

💡 **במצב פעיל:** השתמש בתרופות שמפנות חומצה אורית קיימת (רזבוריקז)""",
            "order_index": 6
        },
        {
            "title": "3. רזבוריקז (Rasburicase)",
            "section_type": "text",
            "content": """**מנגנון פעולה:**
מורידה **באופן אקטיבי** רמות של חומצה אורית בסרום

**שונה מאלופרינול:**
- אלופרינול: מונע ייצור חדש
- רזבוריקז: מורידה רמות קיימות ✅

🍄 **מקור:** פותחה מ-*Aspergillus flavus* (פטרייה)

**אינדיקציות מועדפות:**
- ✅ אי ספיקה כלייתית
- ✅ אי ספיקת לב
- ✅ TLS פעיל
- ✅ סיכון גבוה

→ **רזבוריקז היא האלטרנטיבה המועדפת על פני אלופרינול בקרב חולים עם אי ספיקה**""",
            "order_index": 7
        },
        {
            "title": "למרות מניעה - TLS עדיין קורה",
            "section_type": "alert",
            "content": """⚠️ **סטטיסטיקה חשובה:**

למרות מתן פרופילקטי של הידרציה ותרופות:
**3-5% עדיין מפתחים TLS**

🔴 **קבוצות סיכון גבוה במיוחד:**
- Non-Hodgkin Lymphoma (NHL)
- ALL (Acute Lymphoblastic Leukemia)

→ **TLS יכול להתפתח ספונטנית** ללא קשר לטיפול כימוטרפי!""",
            "order_index": 8
        },
        {
            "title": "טיפול ב-TLS פעיל",
            "section_type": "steps",
            "content": "חולים עם TLS זקוקים לטיפול תומך אינטנסיבי:",
            "metadata": {
                "steps": [
                    "**הידרציה** אגרסיבית IV",
                    "**רזבוריקז** (Rasburicase)",
                    "**ניטור תפוקת שתן** רציף",
                    "**ניטור קרדיאלי** מתמיד",
                    "**מעקב אלקטרוליטים** כל 4-6 שעות",
                    "**מוכנות לדיאליזה** במידת הצורך"
                ]
            },
            "order_index": 9
        },
        {
            "title": "היפרקלמיה ב-TLS - הסכנה הגדולה",
            "section_type": "alert",
            "content": """⚡ **סיכון מיידי למוות!**

**הסכנה:**
היפרקלמיה חמורה → הפרעות קצב קטלניות → מוות פתאומי

💔 **Cardiac Dysrhythmia**""",
            "order_index": 10
        },
        {
            "title": "טיפול בהיפרקלמיה ב-TLS",
            "section_type": "options",
            "content": "פרוטוקול טיפולי מלא:",
            "metadata": {
                "options": [
                    {
                        "title": "קיי אקסלט (Kayexalate)",
                        "description": "חילוף יונים במעי - מוריד K+ באופן הדרגתי"
                    },
                    {
                        "title": "גלוקוז + אינסולין",
                        "description": "מעביר K+ לתוך התאים - השפעה מהירה"
                    },
                    {
                        "title": "בטא אגוניסטים (ונטולין - Salbutamol)",
                        "description": "מעביר K+ לתוך התאים דרך משאבת Na-K-ATPase"
                    },
                    {
                        "title": "קלציום גלוקונט (Calcium Gluconate)",
                        "description": "**להגנת הלב** - מייצב את הממברנה הקרדיאלית ומונע dysrhythmia. לא מוריד K+!",
                        "indication": "חובה במקרה של שינויים ב-EKG או K+ גבוה מאוד"
                    },
                    {
                        "title": "דיאליזה / המופילטרציה",
                        "description": "הטיפול הסופי - מסיר K+ מהדם ישירות",
                        "indication": "במידה ולא מושגת שליטה על רמות K+ עם הטיפולים האחרים"
                    }
                ]
            },
            "order_index": 11
        },
        {
            "title": "היפוקלצמיה ב-TLS",
            "section_type": "alert",
            "content": """⚠️ **זהירות בתיקון קלציום!**

**העיקרון:**
תקן עם **מינימום קלציום שאפשר**

**למה?**
כדי למנוע משקעי **קלציום-פוספט** בכליות

→ היפרפוספטמיה + קלציום = משקעים קטלניים בכליות

💡 **תקן רק אם:**
- סימפטומטי (טטניה, התכווצויות)
- רמות מסכנות חיים
- לא לתקן "לפי מספרים" בלבד!""",
            "order_index": 12
        },
        {
            "title": "מקרה מייצג: יילוד עם 800,000 לויקוציטים",
            "section_type": "text",
            "content": """**תרחיש קיצון:**
יילוד מגיע לטיפול נמרץ עם:
- **AML** (Acute Myeloid Leukemia)
- **ספירת לויקוציטים: 800,000** (נורמה: עד 30,000)

→ **היפרלויקוציטוזיס (Hyperleukocytosis)**

**הסכנות המיידיות:**

1️⃣ **סיכון קיצוני ל-TLS:**
- "עומס הגידול" עצום
- כל טיפול שיגרום להרס תאים → TLS מסיבי וקטלני

2️⃣ **לויקוסטאזיס (Leukostasis):**
- צמיגות הדם עולה (hyper-viscosity)
- חסימת כלי דם קטנים במוח ובריאות
- תסחיף שומן
- **סיכון מיידי לשבץ או כשל נשימתי**""",
            "order_index": 13
        },
        {
            "title": "טיפול בהיפרלויקוציטוזיס - מרוץ נגד הזמן",
            "section_type": "steps",
            "content": "**גישה שונה לחלוטין:**",
            "metadata": {
                "steps": [
                    "**ציטורדוקציה דחופה (Urgent Cytoreduction)** - המטרה הראשונה: לא להרוג את הסרטן, אלא להוריד את ספירת התאים במהירות ובצורה מבוקרת",
                    "**החלפת דם (Exchange Transfusion)** - ביילוד: דילול מכני של הדם",
                    "**מניעת TLS אגרסיבית** - הידרציה + רזבוריקז עוד לפני תחילת הטיפול (גם התפרקות ספונטנית היא איום!)",
                    "**אשפוז בטיפול נמרץ** - ניטור בלתי פוסק של כל המדדים",
                    "**מוכנות מיידית לדיאליזה** - אם הכליות קורסות"
                ]
            },
            "order_index": 14
        },
        {
            "title": "נקודות מפתח",
            "section_type": "alert",
            "content": """📋 **שורה תחתונה:**

⚠️ **TLS = מצב חירום** שדורש חשיבה קדימה ומניעה אגרסיבית

🎯 **פתופיזיולוגיה:**
- פירוק תאים → K↑, PO₄↑, Uric Acid↑
- חומצה אורית + קלציום פוספט → משקעים בכליות
- → Acute Kidney Injury

🔬 **מתי זה קורה:**
- לימפומות, ALL (בעיקר)
- לאחר כימותרפיה או ספונטנית
- 3-5% למרות מניעה!

💊 **מניעה:**
- הידרציה אגרסיבית
- אלופרינול (מונע ייצור) / רזבוריקז (מורידה רמות)
- רזבוריקז מועדפת באי ספיקה כלייתית/לבבית

⚡ **הסכנה הגדולה - היפרקלמיה:**
- מוות פתאומי מהפרעות קצב
- טיפול: קיי אקסלט, גלוקוז-אינסולין, ונטולין, Ca-Gluconate
- דיאליזה במידת הצורך

🩸 **היפרלויקוציטוזיס:**
- סכנה כפולה: TLS + לויקוסטאזיס
- טיפול: ציטורדוקציה דחופה, החלפת דם, מניעה אגרסיבית
- מטרה: הורדת מסת גידול לפני כימותרפיה מלאה

🔑 **עיקרון זהב:** במקרה של TLS - חשוב קדימה, מנע אגרסיבית, וטפל מהר!""",
            "order_index": 15
        }
    ]
    
    print(f"\n📑 מוסיף {len(sections)} מקטעים...")
    
    for idx, section in enumerate(sections, 1):
        section['topic_id'] = topic_id
        result = create_content_section(section)
        
        if result:
            print(f"  ✅ {idx}. {section['title']}")
        else:
            print(f"  ❌ {idx}. {section['title']} - נכשל")
    
    print("\n" + "="*60)
    print("✅ התוכן נוסף בהצלחה למסד הנתונים!")
    print("="*60)
    print(f"\n📊 סיכום:")
    print(f"   נושא: Tumor Lysis Syndrome (TLS)")
    print(f"   קטגוריה: המטולוגיה/אונקולוגיה")
    print(f"   מקטעים: {len(sections)}")
    print(f"   ID: {topic_id}")
    
    return True

if __name__ == "__main__":
    print("⚠️ PICU Learning Platform - הוספת תוכן")
    print("="*60)
    print("נושא: Tumor Lysis Syndrome (TLS)")
    print("="*60)
    
    try:
        success = add_tls_content()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - הגדרה ופתופיזיולוגיה")
            print("   - מניעה (הידרציה, אלופרינול, רזבוריקז)")
            print("   - טיפול ב-TLS פעיל")
            print("   - ניהול היפרקלמיה")
            print("   - מקרה מייצג: היפרלויקוציטוזיס")
            print("   - נקודות מפתח מקיפות")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
