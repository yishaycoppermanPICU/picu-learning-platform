import streamlit as st
import random
import json
from datetime import datetime

st.set_page_config(page_title="××‘×—× ×™×", page_icon="ğŸ“", layout="wide")

# CSS
st.markdown("""
<style>
    .stApp {
        direction: rtl;
    }
    .question-box {
        background: #f0f2f6;
        padding: 2rem;
        border-radius:  10px;
        margin:  1rem 0;
        border-left: 5px solid #4CAF50;
    }
    .score-display {
        font-size: 3rem;
        text-align: center;
        padding: 2rem;
    }
</style>
""", unsafe_allow_html=True)

st.title("ğŸ“ ××¨×›×– ×”××‘×—× ×™×")
st.markdown("---")

# ×‘× ×§ ×©××œ×•×ª
question_bank = {
    "×”×—×™×™××”":  [
        {
            "question":  "××”×• ×”×™×—×¡ ×”× ×›×•×Ÿ ×©×œ ×œ×—×™×¦×•×ª ×œ×”× ×©××•×ª ×‘×”×—×™×™××ª ×™×œ×“ ×¢× ×©× ×™ ××˜×¤×œ×™×?",
            "options": ["30:2", "15:2", "5:1", "3:1"],
            "correct":  1,
            "explanation":  "×¢× 2 ××˜×¤×œ×™× ×‘×™×œ×“×™×, ×”×™×—×¡ ×”×•× 15:2. ×‘×™×—×™×“ - 30:2"
        },
        {
            "question": "××”×• ×”××™× ×•×Ÿ ×©×œ ××¤×™× ×¤×¨×™×Ÿ IV/IO ×‘×”×—×™×™××”?",
            "options": ["0.1 ××’/×§×’", "0.01 ××’/×§×’", "1 ××’/×§×’", "0.001 ××’/×§×’"],
            "correct": 1,
            "explanation": "×”××™× ×•×Ÿ ×”×•× 0.01 ××’/×§×’ (0.1 ××œ/×§×’ ××ª××™×¡×” 1:10,000)"
        },
        {
            "question": "××”×• ×¢×•××§ ×”×œ×—×™×¦×•×ª ×”××•××œ×¥ ×‘×”×—×™×™××ª ×™×œ×“?",
            "options": ["1/4 ××¢×•××§ ×”×—×–×”", "1/3 ××¢×•××§ ×”×—×–×”", "1/2 ××¢×•××§ ×”×—×–×”", "2 ×¡\"×"],
            "correct": 1,
            "explanation": "×¢×•××§ ×”×œ×—×™×¦×•×ª ×¦×¨×™×š ×œ×”×™×•×ª 1/3 ××¢×•××§ ×”×—×–×” (×›-5 ×¡\"× ×‘×™×œ×“)"
        },
        {
            "question":  "×‘××™×–×” ×§×¦×‘ ××‘×•×¦×¢×•×ª ×œ×—×™×¦×•×ª ×—×–×” ×‘×”×—×™×™××”?",
            "options": ["80-100/×“×§×”", "100-120/×“×§×”", "120-140/×“×§×”", "60-80/×“×§×”"],
            "correct": 1,
            "explanation": "×§×¦×‘ ×”×œ×—×™×¦×•×ª ×¦×¨×™×š ×œ×”×™×•×ª 100-120 ×œ×“×§×”"
        },
        {
            "question":  "××ª×™ × ×•×ª× ×™× ×××™×•×“×¨×•×Ÿ ×‘×”×—×™×™××”?",
            "options": ["××™×“ ×‘×ª×—×™×œ×ª ×”×”×—×™×™××”", "×‘-VF/pulseless VT", "×‘××¡×™×¡×˜×•×œ×”", "×‘-PEA"],
            "correct": 1,
            "explanation": "×××™×•×“×¨×•×Ÿ × ×™×ª×Ÿ ×‘-VF ××• pulseless VT ×¢××™×“ ×œ×“×¤×™×‘×¨×™×œ×¦×™×”"
        }
    ],
    "×”× ×©××”": [
        {
            "question": "××”×• ×”-Tidal Volume ×”××•××œ×¥ ×‘×”× ×©××” ××›× ×™×ª ×‘×™×œ×“×™×?",
            "options": ["4-6 ××œ/×§×’", "6-8 ××œ/×§×’", "8-10 ××œ/×§×’", "10-12 ××œ/×§×’"],
            "correct": 1,
            "explanation": "Tidal Volume ×©×œ 6-8 ××œ/×§×’ ×œ×¤×™ ××©×§×œ ×’×•×£ ××™×“×™××œ×™"
        },
        {
            "question":  "××”×• ×”-PEEP ×”×”×ª×—×œ×ª×™ ×”××•××œ×¥?",
            "options":  ["0-2", "3-5", "5-8", "8-10"],
            "correct":  1,
            "explanation":  "PEEP ×”×ª×—×œ×ª×™ ×©×œ 3-5 cmH2O ××ª××™× ×œ×¨×•×‘ ×”××˜×•×¤×œ×™×"
        }
    ],
    "×ª×¨×•×¤×•×ª": [
        {
            "question": "××”×• ×”××™× ×•×Ÿ ×©×œ ××™×“×–×•×œ× IV ×œ×¡×“×¦×™×”?",
            "options":  ["0.05-0.1 ××’/×§×’", "0.1-0.2 ××’/×§×’", "0.5-1 ××’/×§×’", "1-2 ××’/×§×’"],
            "correct": 0,
            "explanation": "××™×“×–×•×œ× IV:  0.05-0.1 ××’/×§×’, × ×™×ª×Ÿ ×œ×—×–×•×¨ ×›×œ 2-3 ×“×§×•×ª"
        }
    ]
}

# ××ª×—×•×œ ××©×ª× ×™×
if 'quiz_state' not in st.session_state:
    st.session_state.quiz_state = 'menu'  # menu, ongoing, finished
if 'current_questions' not in st.session_state:
    st.session_state.current_questions = []
if 'current_index' not in st.session_state:
    st.session_state.current_index = 0
if 'user_answers' not in st.session_state:
    st.session_state.user_answers = []
if 'score' not in st.session_state:
    st.session_state.score = 0

# ×ª×¤×¨×™×˜ ×¨××©×™
if st.session_state.quiz_state == 'menu':
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("ğŸ¯ ×‘×—×¨ ×¡×•×’ ××‘×—×Ÿ")
        
        quiz_type = st.radio(
            "×¡×•×’ ×”××‘×—×Ÿ:",
            ["××‘×—×Ÿ ×§×¦×¨ (5 ×©××œ×•×ª)", "××‘×—×Ÿ ×¨×’×™×œ (10 ×©××œ×•×ª)", "××‘×—×Ÿ ××§×™×£ (20 ×©××œ×•×ª)"],
            label_visibility="collapsed"
        )
        
        topic = st.selectbox(
            "× ×•×©×:",
            ["×›×œ ×”× ×•×©××™×", "×”×—×™×™××”", "×”× ×©××”", "×ª×¨×•×¤×•×ª"]
        )
    
    with col2:
        st.info("""
        ### ğŸ“‹ ×”×•×¨××•×ª: 
        - ×§×¨× ×›×œ ×©××œ×” ×‘×¢×™×•×Ÿ
        - ×‘×—×¨ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×” ×‘×™×•×ª×¨
        - ×œ××—×¨ ×”×’×©×ª ×”×ª×©×•×‘×” ×ª×§×‘×œ ×”×¡×‘×¨ ××¤×•×¨×˜
        - ×‘×¡×•×£ ×”××‘×—×Ÿ ×ª×§×‘×œ ×¦×™×•×Ÿ ×•×¡×™×›×•× ×‘×™×¦×•×¢×™×
        
        ### â±ï¸ ×–××Ÿ ××©×•×¢×¨:
        - ××‘×—×Ÿ ×§×¦×¨: 5 ×“×§×•×ª
        - ××‘×—×Ÿ ×¨×’×™×œ: 10 ×“×§×•×ª
        - ××‘×—×Ÿ ××§×™×£: 20 ×“×§×•×ª
        """)
    
    if st.button("ğŸš€ ×”×ª×—×œ ××‘×—×Ÿ", type="primary", use_container_width=True):
        # ×”×›× ×ª ×©××œ×•×ª ×œ××‘×—×Ÿ
        num_questions = 5 if "×§×¦×¨" in quiz_type else 10 if "×¨×’×™×œ" in quiz_type else 20
        
        if topic == "×›×œ ×”× ×•×©××™×":
            all_questions = []
            for topic_questions in question_bank.values():
                all_questions.extend(topic_questions)
        else:
            all_questions = question_bank. get(topic, [])
        
        if len(all_questions) >= num_questions:
            st. session_state.current_questions = random.sample(all_questions, num_questions)
        else:
            st.session_state.current_questions = all_questions
        
        st. session_state.current_index = 0
        st.session_state.user_answers = []
        st.session_state. score = 0
        st. session_state.quiz_state = 'ongoing'
        st.rerun()

# ××‘×—×Ÿ ×¤×¢×™×œ
elif st.session_state.quiz_state == 'ongoing':
    # ×¤×¨×•×’×¨×¡ ×‘×¨
    progress = (st.session_state.current_index + 1) / len(st.session_state.current_questions)
    st.progress(progress)
    
    col1, col2, col3 = st.columns([2, 3, 1])
    with col1:
        st.write(f"×©××œ×” {st.session_state.current_index + 1} ××ª×•×š {len(st. session_state.current_questions)}")
    with col3:
        if st.button("âŒ ×™×¦×™××”"):
            st.session_state. quiz_state = 'menu'
            st.rerun()
    
    # ×”×¦×’×ª ×©××œ×”
    current_q = st.session_state.current_questions[st.session_state.current_index]
    
    st.markdown(f"""
    <div class="question-box">
        <h3>â“ {current_q['question']}</h3>
    </div>
    """, unsafe_allow_html=True)
    
    # ××¤×©×¨×•×™×•×ª ×ª×©×•×‘×”
    selected = st.radio(
        "×‘×—×¨ ×ª×©×•×‘×”:",
        current_q['options'],
        key=f"q_{st.session_state.current_index}"
    )
    
    col1, col2 = st. columns(2)
    
    with col1:
        if st.button("âœ… ×”×’×© ×ª×©×•×‘×”", type="primary", use_container_width=True):
            if selected: 
                # ×‘×“×™×§×ª ×ª×©×•×‘×”
                selected_index = current_q['options'].index(selected)
                is_correct = selected_index == current_q['correct']
                
                st.session_state.user_answers.append({
                    'question': current_q['question'],
                    'selected': selected,
                    'correct_answer': current_q['options'][current_q['correct']],
                    'is_correct': is_correct,
                    'explanation': current_q['explanation']
                })
                
                if is_correct:
                    st. success("âœ… ×ª×©×•×‘×” × ×›×•× ×”!")
                    st. session_state.score += 1
                else:
                    st.error(f"âŒ ×ª×©×•×‘×” ×©×’×•×™×”. ×”×ª×©×•×‘×” ×”× ×›×•× ×”:  {current_q['options'][current_q['correct']]}")
                
                st.info(f"ğŸ’¡ ×”×¡×‘×¨: {current_q['explanation']}")
                
    with col2:
        if len(st.session_state.user_answers) > st.session_state.current_index:
            if st.button("â¡ï¸ ×©××œ×” ×”×‘××”", use_container_width=True):
                if st.session_state.current_index < len(st.session_state. current_questions) - 1:
                    st.session_state.current_index += 1
                    st.rerun()
                else:
                    st.session_state.quiz_state = 'finished'
                    st. rerun()

# ×¡×™×•× ××‘×—×Ÿ
elif st. session_state.quiz_state == 'finished':
    st. balloons()
    
    # ×—×™×©×•×‘ ×¦×™×•×Ÿ
    total_questions = len(st.session_state.current_questions)
    correct_answers = st.session_state.score
    score_percentage = (correct_answers / total_questions) * 100
    
    # ×”×¦×’×ª ×¦×™×•×Ÿ
    if score_percentage >= 80:
        color = "green"
        emoji = "ğŸŒŸ"
        message = "××¦×•×™×Ÿ!"
    elif score_percentage >= 60:
        color = "orange"
        emoji = "ğŸ‘"
        message = "×˜×•×‘!"
    else:
        color = "red"
        emoji = "ğŸ“š"
        message = "×›×“××™ ×œ×—×–×•×¨ ×¢×œ ×”×—×•××¨"
    
    st.markdown(f"""
    <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
        <h1>{emoji} {message}</h1>
        <div class="score-display">{score_percentage:.0f}%</div>
        <p>×¢× ×™×ª × ×›×•×Ÿ ×¢×œ {correct_answers} ××ª×•×š {total_questions} ×©××œ×•×ª</p>
    </div>
    """, unsafe_allow_html=True)
    
    # ×¤×™×¨×•×˜ ×ª×©×•×‘×•×ª
    with st.expander("ğŸ“Š ×¤×™×¨×•×˜ ×”×ª×©×•×‘×•×ª ×©×œ×š", expanded=True):
        for i, answer in enumerate(st.session_state. user_answers, 1):
            if answer['is_correct']:
                st.success(f"âœ… ×©××œ×” {i}: × ×›×•×Ÿ")
            else:
                st.error(f"âŒ ×©××œ×” {i}: ×©×’×•×™")
                st.write(f"**×”×©××œ×”:** {answer['question']}")
                st.write(f"**×‘×—×¨×ª:** {answer['selected']}")
                st.write(f"**×ª×©×•×‘×” × ×›×•× ×”:** {answer['correct_answer']}")
                st. write(f"**×”×¡×‘×¨:** {answer['explanation']}")
            st.divider()
    
    # ×©××™×¨×ª ×ª×•×¦××•×ª
    if st.session_state.get('logged_in', False):
        # ×©××™×¨×” ×œ×¡×˜×˜×™×¡×˜×™×§×•×ª ×”××©×ª××©
        if 'user_scores' not in st.session_state:
            st.session_state.user_scores = []
        
        st.session_state.user_scores.append({
            'date':  datetime.now().strftime("%Y-%m-%d %H:%M"),
            'score': score_percentage,
            'questions': total_questions,
            'correct': correct_answers
        })
    
    # ×›×¤×ª×•×¨×™ ×”××©×š
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸ”„ ××‘×—×Ÿ ×—×“×©", type="primary", use_container_width=True):
            st.session_state.quiz_state = 'menu'
            st. session_state.current_questions = []
            st.session_state. current_index = 0
            st.session_state.user_answers = []
            st.session_state.score = 0
            st.rerun()
    
    with col2:
        if st.button("ğŸ“š ×—×–×¨×” ×œ×œ××™×“×”", use_container_width=True):
            st.switch_page("pages/1_ğŸ“š_Learning.py")
    
    with col3:
        if st.button("ğŸ“Š ×”×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×œ×™", use_container_width=True):
            st.switch_page("pages/3_ğŸ“Š_Statistics.py")

# ×¡×¨×’×œ ×¦×“ - ×¡×˜×˜×™×¡×˜×™×§×•×ª ××”×™×¨×•×ª
with st.sidebar:
    st.subheader("ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××”×™×¨×•×ª")
    
    if st.session_state.get('user_scores', []):
        scores = [s['score'] for s in st.session_state.user_scores]
        st.metric("×××•×¦×¢ ×›×œ×œ×™", f"{sum(scores)/len(scores):.1f}%")
        st.metric("××‘×—× ×™× ×©×”×•×©×œ××•", len(scores))
        st.metric("×”×¦×™×•×Ÿ ×”×’×‘×•×” ×‘×™×•×ª×¨", f"{max(scores):.0f}%")
    else:
        st.info("×¢×“×™×™×Ÿ ××™×Ÿ × ×ª×•× ×™×")
