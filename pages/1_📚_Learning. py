import streamlit as st
import json
from datetime import datetime

try:
    from utils.database import (
        init_supabase,
        get_topics,
        get_learning_content,
        mark_content_as_completed,
        get_user_progress,
        DB_CONNECTED
    )
except: 
    DB_CONNECTED = False

st.set_page_config(page_title="×œ××™×“×”", page_icon="ğŸ“š", layout="wide")

# CSS
st.markdown("""
<style>
    .stApp {
        direction: rtl;
    }
    .progress-bar {
        background-color: #f0f0f0;
        border-radius: 10px;
        padding: 3px;
        margin: 10px 0;
    }
    .progress-fill {
        background:  linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 20px;
        border-radius: 7px;
        text-align: center;
        color: white;
        font-weight: bold;
    }
    .topic-card {
        padding: 1. 5rem;
        border-radius: 10px;
        background:  white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .topic-card:hover {
        transform: translateY(-5px);
        box-shadow:  0 5px 15px rgba(0,0,0,0.2);
    }
    .completed {
        background: linear-gradient(45deg, #d4edda 0%, #c3e6cb 100%);
    }
</style>
""", unsafe_allow_html=True)

# ×‘×“×™×§×ª ×”×ª×—×‘×¨×•×ª
if not st.session_state.get('logged_in', False):
    st.error("×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ×—×•××¨×™ ×”×œ××™×“×”")
    st.stop()

user = st.session_state.get('user', {})
user_id = user.get('id')

st.title("ğŸ“š ×—×•××¨×™ ×œ××™×“×”")

# ×ª×¤×¨×™×˜ ×¦×“ - ×‘×—×™×¨×ª × ×•×©×
with st.sidebar:
    st. subheader("ğŸ¯ ×‘×—×¨ × ×•×©× ×œ×œ××™×“×”")
    
    if DB_CONNECTED:
        topics = get_topics()
        
        if topics:
            # ×—×™×©×•×‘ ××—×•×– ×”×ª×§×“××•×ª ×œ×›×œ × ×•×©×
            for topic in topics:
                if user_id:
                    progress = get_user_progress(user_id, topic['id'])
                    topic['progress'] = progress. get('percentage', 0) if progress else 0
                else:
                    topic['progress'] = 0
            
            # ×”×¦×’×ª × ×•×©××™× ×¢× ×”×ª×§×“××•×ª
            selected_topic_id = None
            for topic in topics:
                col1, col2 = st. columns([3, 1])
                with col1:
                    if st.button(
                        f"{topic. get('icon', 'ğŸ“š')} {topic['title']}", 
                        key=f"topic_{topic['id']}",
                        use_container_width=True
                    ):
                        selected_topic_id = topic['id']
                        st.session_state.selected_topic = topic
                with col2:
                    if topic['progress'] > 0:
                        st.progress(topic['progress'] / 100)
                        st.caption(f"{topic['progress']:.0f}%")
                    else:
                        st.caption("0%")
        else:
            st.info("××™×Ÿ × ×•×©××™× ×–××™× ×™×")
    else:
        st.warning("××¦×‘ ×“××• - ××™×Ÿ ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×")

# ×ª×¦×•×’×” ×¨××©×™×ª
if 'selected_topic' in st.session_state:
    topic = st.session_state. selected_topic
    
    # ×›×•×ª×¨×ª ×”× ×•×©×
    st.header(f"{topic.get('icon', 'ğŸ“š')} {topic['title']}")
    st.info(topic. get('description', ''))
    
    # ×¡×¨×’×œ ×”×ª×§×“××•×ª ×›×œ×œ×™
    progress = topic.get('progress', 0)
    st.markdown(f"""
    <div class="progress-bar">
        <div class="progress-fill" style="width: {progress}%;">
            {progress:. 0f}% ×”×•×©×œ×
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # ×ª×¤×¨×™×˜ ×¤×¢×•×œ×•×ª
    tab1, tab2, tab3 = st.tabs(["ğŸ“– ×—×•××¨ ×œ××™×“×”", "âœ… ×”×ª×§×“××•×ª", "ğŸ“ ×ª×¨×’×•×œ"])
    
    with tab1:
        st.subheader("×—×•××¨×™ ×œ××™×“×” ×‘× ×•×©×")
        
        if DB_CONNECTED and user_id:
            # ×˜×¢×™× ×ª ×ª×›× ×™ ×œ××™×“×”
            contents = get_learning_content(topic['id'])
            
            if contents:
                for i, content in enumerate(contents, 1):
                    # ×‘×“×™×§×” ×× ×”×•×©×œ×
                    completed = content.get('completed', False)
                    
                    with st. expander(
                        f"{'âœ…' if completed else 'ğŸ“„'} {i}. {content['title']}",
                        expanded=not completed
                    ):
                        # ×”×¦×’×ª ×”×ª×•×›×Ÿ
                        if content['content_type'] == 'text': 
                            st.markdown(content['content'])
                        elif content['content_type'] == 'video':
                            st.video(content['content'])
                        elif content['content_type'] == 'image':
                            st.image(content['content'])
                        
                        # ×›×¤×ª×•×¨ ×¡×™××•×Ÿ ×”×©×œ××”
                        col1, col2, col3 = st.columns([1, 1, 3])
                        with col1:
                            if not completed:
                                if st. button(f"âœ… ×¡××Ÿ ×›×”×•×©×œ×", key=f"complete_{content['id']}"):
                                    if mark_content_as_completed(user_id, topic['id'], content['id']):
                                        st.success("×¡×•××Ÿ ×›×”×•×©×œ×!")
                                        st.rerun()
                            else: 
                                st.success("×”×•×©×œ× âœ…")
                        
                        with col2:
                            if completed:
                                if st.button(f"â†©ï¸ ×‘×˜×œ ×¡×™××•×Ÿ", key=f"uncomplete_{content['id']}"):
                                    # ×¤×•× ×§×¦×™×” ×œ×‘×™×˜×•×œ ×¡×™××•×Ÿ
                                    st.info("×‘×•×˜×œ")
                                    st.rerun()
            else:
                st.info("××™×Ÿ ×ª×›× ×™× ×–××™× ×™× ×¢×“×™×™×Ÿ ×‘× ×•×©× ×–×”")
        else:
            # ×ª×•×›×Ÿ ×“××•
            st.markdown("""
            ### 1. ××‘×•× ×œ× ×•×©×
            ×–×”×• ×ª×•×›×Ÿ ×œ×“×•×’××”.  ×‘××¦×‘ ××œ×, ×›××Ÿ ×™×•×¤×™×¢×• ×—×•××¨×™ ×”×œ××™×“×” ×”××œ××™×. 
            
            ### 2. ×¢×§×¨×•× ×•×ª ×‘×¡×™×¡×™×™×
            - × ×§×•×“×” ×¨××©×•× ×”
            - × ×§×•×“×” ×©× ×™×™×”
            - × ×§×•×“×” ×©×œ×™×©×™×ª
            
            ### 3. ×™×™×©×•× ×§×œ×™× ×™
            ×“×•×’×××•×ª ××¢×©×™×•×ª ×•××§×¨×™× ×§×œ×™× ×™×™×
            """)
            
            if st.button("âœ… ×¡××Ÿ ×¤×¨×§ ×–×” ×›×”×•×©×œ×"):
                st.success("×¡×•××Ÿ ×›×”×•×©×œ×!  (Demo)")
    
    with tab2:
        st.subheader("ğŸ“Š ×¡×˜×˜×•×¡ ×”×”×ª×§×“××•×ª ×©×œ×š")
        
        if DB_CONNECTED and user_id: 
            progress_data = get_user_progress(user_id, topic['id'])
            
            if progress_data:
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("×¤×¨×§×™× ×©×”×•×©×œ××•", f"{progress_data.get('completed', 0)}/{progress_data.get('total', 0)}")
                
                with col2:
                    st.metric("××—×•×– ×”×©×œ××”", f"{progress_data.get('percentage', 0):.0f}%")
                
                with col3:
                    last_activity = progress_data.get('last_activity')
                    if last_activity:
                        st. metric("×¤×¢×™×œ×•×ª ××—×¨×•× ×”", last_activity)
                    else: 
                        st.metric("×¤×¢×™×œ×•×ª ××—×¨×•× ×”", "â€”")
                
                # ×¨×©×™××ª ×¤×¨×§×™× ×¢× ×¡×˜×˜×•×¡
                st. markdown("### ğŸ“‹ ×¤×™×¨×•×˜ ×¤×¨×§×™×:")
                
                contents = get_learning_content(topic['id'])
                for content in contents:
                    if content.get('completed'):
                        st.markdown(f"âœ… ~~{content['title']}~~")
                    else:
                        st.markdown(f"â¬œ {content['title']}")
            else:
                st.info("×”×ª×—×œ ×œ×œ××•×“ ×›×“×™ ×œ×¨××•×ª ××ª ×”×”×ª×§×“××•×ª ×©×œ×š")
        else:
            # Demo progress
            st.metric("×”×ª×§×“××•×ª", "40%")
            st.progress(0.4)
            st.markdown("""
            âœ… ×¤×¨×§ 1: ××‘×•×  
            âœ… ×¤×¨×§ 2: ×¢×§×¨×•× ×•×ª  
            â¬œ ×¤×¨×§ 3: ×™×™×©×•×  
            â¬œ ×¤×¨×§ 4: ×ª×¨×’×•×œ  
            """)
    
    with tab3:
        st.subheader("ğŸ“ ×ª×¨×’×•×œ ×××•×§×“")
        
        st.info("×‘×—×¨ ×¢×œ ××” ×ª×¨×¦×” ×œ×”×™×‘×—×Ÿ:")
        
        col1, col2 = st. columns(2)
        
        with col1:
            if st.button("ğŸ“ ××‘×—×Ÿ ×¢×œ ×›×œ ×”× ×•×©×", use_container_width=True):
                st.session_state.quiz_topic = topic['id']
                st.session_state.quiz_type = 'full'
                st.switch_page("pages/2_ğŸ“_Quizzes.py")
        
        with col2:
            if st.button("ğŸ¯ ×¨×§ ×¢×œ ××” ×©×œ××“×ª×™", use_container_width=True):
                st.session_state.quiz_topic = topic['id']
                st.session_state.quiz_type = 'learned_only'
                st.switch_page("pages/2_ğŸ“_Quizzes.py")
        
        st.divider()
        
        # ××¤×©×¨×•×™×•×ª × ×•×¡×¤×•×ª
        st.markdown("### âš™ï¸ ×”×’×“×¨×•×ª ×ª×¨×’×•×œ ××ª×§×“××•×ª:")
        
        num_questions = st.slider("××¡×¤×¨ ×©××œ×•×ª", 5, 50, 10)
        difficulty = st.select_slider(
            "×¨××ª ×§×•×©×™",
            options=["×§×œ", "×‘×™× ×•× ×™", "×§×©×”", "××¢×•×¨×‘"],
            value="××¢×•×¨×‘"
        )
        
        if st.button("ğŸš€ ×”×ª×—×œ ×ª×¨×’×•×œ ××•×ª×× ××™×©×™×ª", type="primary"):
            st.session_state.quiz_settings = {
                'topic':  topic['id'],
                'num_questions': num_questions,
                'difficulty': difficulty
            }
            st.switch_page("pages/2_ğŸ“_Quizzes.py")

else:
    # ×× ×œ× × ×‘×—×¨ × ×•×©×
    st.info("ğŸ‘ˆ ×‘×—×¨ × ×•×©× ××”×ª×¤×¨×™×˜ ×”×¦×“×“×™ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×œ××•×“")
    
    # ×”×¦×’×ª ×›×œ ×”× ×•×©××™× ×›×›×¨×˜×™×¡×™×
    st.subheader("ğŸ¯ × ×•×©××™ ×œ××™×“×” ×–××™× ×™×:")
    
    if DB_CONNECTED:
        topics = get_topics()
        if topics:
            cols = st.columns(3)
            for i, topic in enumerate(topics):
                with cols[i % 3]:
                    st.markdown(f"""
                    <div class="topic-card">
                        <h3>{topic. get('icon', 'ğŸ“š')} {topic['title']}</h3>
                        <p>{topic.get('description', '')}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {topic. get('progress', 0)}%;">
                                {topic.get('progress', 0)}%
                            </div>
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
