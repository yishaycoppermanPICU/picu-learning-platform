#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: תרופות החייאה (Resuscitation Medications)
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_resuscitation_medications():
    """הוספת תרופות החייאה"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: תרופות החייאה...")
    
    topic_data = {
        "title": "תרופות החייאה - Resuscitation Medications",
        "category": "medications",
        "description": "מדריך מקיף לתרופות קריטיות בהחייאה: אדרנלין, אטרופין, אדנוזין, קלציום, לידוקאין ועוד",
        "icon": "💊",
        "slug": "resuscitation_medications",
        "tags": ["תרופות", "החייאה", "PALS", "אדרנלין", "אפינפרין", "אטרופין", "אדנוזין", "קלציום", "לידוקאין"],
        "order_index": 1
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "אדרנלין (אפינפרין) - Epinephrine",
            "section_type": "text",
            "content": """**Epinephrine (Adrenaline) - אדרנלין**

**מנגנון פעולה:**
- כיווץ כלי דם (Vasoconstriction)
- הרחבת סמפונות (Bronchodilation)
- מעלה SVR (Systemic Vascular Resistance)

**מינון החייאה:**
💉 **0.01 mg/kg**
- מקסימום למנה: **1 mg**
- תדירות: **כל 2 דקות** (לפי פרוטוקול PALS)
- 🔄 ממשיכים עד לחזרת דופק ולחץ דם, או עד לקביעת מוות
- ⚠️ אין מספר מנות מקסימלי בהחייאה

**מינון במתן מתמשך:**
💧 **0.05-0.2 mg/kg/hr** (עירוי)

**שימושים נוספים:**

**1️⃣ אינהלציה לסטרידור:**
- מינון: **400 mcg/kg**
- מקסימום למנה: **5 mg**
- 🎯 **לאחר אקסטובציה:** סבירות גבוהה לסטרידור ← מומלץ להכין אינהלציה מראש

**2️⃣ אנפילקסיס:**
- כשאין IV ← **IM** במינון זהה ל-IV
- מינון: **0.01 mg/kg IM**
- מקסימום: **1 mg**

**3️⃣ אסטמה חמורה:**
- ניתן במתן מתמשך""",
            "order_index": 0
        },
        {
            "title": "אטרופין - Atropine",
            "section_type": "text",
            "content": """**Atropine - אטרופין**

**התוויות:**
- טיפול ב**ברדיקרדיה** (בדרך כלל לאחר גירוי ואגאלי)
- באינטובציה לאחר מתן קטמין ← ייבוש הפרשות רוק מוגברות

**מנגנון פעולה:**
אנטגוניסט תחרותי לאצטילכולין ← צמצום פעילות מערכת פרה-סימפתטית

**מינון:**
💉 **0.02 mg/kg**

**מינון מינימלי למנה:**
⚠️ **0.1 mg** - מינון נמוך יותר יגרום לתגובה **פרדוקסלית** (ברדיקרדיה!)

**מינון מקסימלי:**
- ילדים: **1 mg**
- מתבגרים: **1-2 mg**

**⚠️ הערה חשובה בתינוקות:**
בתינוקות במשקל **מתחת ל-5 ק"ג**, מתן מינימלי של 0.1 מ"ג יוצא גבוה מ-0.02 מ"ג/ק"ג, ועלול לגרום להרעלת אטרופין.
**במחלקה:** מקובל לתת למרות זאת""",
            "order_index": 1
        },
        {
            "title": "אדנוזין - Adenosine",
            "section_type": "text",
            "content": """**Adenosine - אדנוזין**

**התוויה:**
טיפול בהפרעות קצב שנגרמות כתוצאה מכניסה חשמלית חוזרת ב-AV node, כמו **SVT**

**השפעה:**
מיד לאחר מתן ← אסיסטולה קצרה ← חזרת דופק תקין או לא תקין

---

**📊 פרוטוכול מתן - מטופל לא יציב המודינמית:**

**מנה ראשונה:**
💉 **0.1 mg/kg**
- מקסימום: **6 mg**

**במידה ואין תגובה ← מנה שנייה:**
💉 **0.2 mg/kg**
- מקסימום: **12 mg**

**במקרים חריגים ← מנה שלישית:**
💉 **0.3 mg/kg**
- מקסימום: **12 mg**

---

**📊 פרוטוכול מתן - מטופל יציב המודינמית:**

**מתחת ל-50 ק"ג:**
- מינון התחלתי: **0.05-0.1 mg/kg**
- מקסימום למנה: **6 mg**
- ניתן להעלות מינון כל **2 דקות**
- מינון מקסימלי: **12 mg** או **0.3 mg/kg**

**מעל 50 ק"ג:**
- מנה ראשונה: **6 mg**
- אם לא אפקטיבי ← **12 mg**
- ניתן לחזור על **12 mg** במידת הצורך

---

**⚠️ אופן מתן קריטי:**

🎯 **עקרונות:**
- יש להזריק בוריד ה**קרוב ביותר ללב**
- דרך ברז המחובר לונטיל
- המזרקים **כבר מחוברים**

🔄 **שלבי מתן:**
1. מזרק אחד: התרופה
2. מזרק שני: שטיפה **מהירה** ב-**5-10 mL NS**

⏱️ **זמן:** אדנוזין מתפרק **מאוד מהר** בדם

**תדירות:** ניתן לתת מנה נוספת כל **2 דקות** ולעלות במינון בהדרגה

---

**📟 ניטור חובה:**
✅ חיבור למוניטור דפיברילטור
✅ ECG בהדפסה **רציפה** (לראות שינויים בזמן אמת)
✅ סימון במוניטור איפה ניתן אדנוזין""",
            "order_index": 2
        },
        {
            "title": "קלציום גלוקונט 10% - Calcium Gluconate",
            "section_type": "text",
            "content": """**Calcium Gluconate 10% - קלציום גלוקונט**

**התוויות:**
- טיפול ב**היפוקלצמיה**
- **הגנה על שריר הלב** בהיפרקלמיה

**מינון בהחייאה:**
💉 **100 mg/kg**
- ניתן לתת בפוש כל **10 דקות** לפי צורך
- מינון מקסימלי: **2000 mg**

**מעקב:**
🧪 עוקבים אחרי **קלציום יוני** בגזים

---

**⚠️ אזהרה קריטית:**
🚨 **קריסטליזציה**
- יש להיזהר מקריסטליזציה
- **חובה לשטוף** לפני ואחרי מתן התרופה

💡 **טיפ קליני:**
בהיפרקלמיה עם קליום גבוה בהחייאה ← נותנים קודם **קלציום** כדי להגן על הלב, לפני אינסולין או תרופות אחרות""",
            "order_index": 3
        },
        {
            "title": "לידוקאין 1% - Lidocaine",
            "section_type": "text",
            "content": """**Lidocaine 1% - לידוקאין**

**התוויה:**
טיפול בהפרעות קצב כמו:
- **VT ללא דופק** (Ventricular Tachycardia)
- **VF** (Ventricular Fibrillation)
- שעמידים לשוק חשמלי

🔗 ניתן **בשילוב עם אפינפרין**

**מינון העמסה:**
💉 **1 mg/kg**
⚠️ **שימו לב:** יש להזריק **לאט**

**המשך טיפול:**
לאחר מינון העמסה ← ממשיכים עם **לידוקאין בעירוי מתמשך**

---

**📍 מתן דרך טובוס אנדוטרכאלי:**
במידה ואין גישה ורידית:
- מינון: **2-3 mg/kg/dose**
- שטיפה עם **5 mL NS**
- **5 הנשמות באמבו** לאחר מכן

---

**❌ התווית נגד:**
**Complete Heart Block** - למעט מטופלים עם קוצב לב פעיל

**⚠️ אזהרה:**
בחלק מהתמיסות המוכנות מראש יש **דקסטרוז המופק מתירס** ← שים לב לאלרגיה או רגישות לתירס""",
            "order_index": 4
        },
        {
            "title": "סודיום ביקרבונט - Sodium Bicarbonate",
            "section_type": "text",
            "content": """**Sodium Bicarbonate - סודיום ביקרבונט**

**מנגנון:**
**בופר לדם** - מייצב pH

**רציונל:**
אמינים (קטכולמינים) עובדים **פחות טוב בסביבה חמוצה** ← לכן חשוב לבסס את הדם

**מינון:**
💉 **1 mEq/kg**

---

**⚠️ שימו לב - ילדים מתחת לגיל שנתיים:**
יש **לדלל את התמיסה כפול 2** עם מים להזרקה

📐 **דילול:**
- 1 חלק ביקרבונט
- 1 חלק מים להזרקה
- = תמיסה מדוללת ×2

💡 **סיבה:** תמיסת ביקרבונט היפראוסמולרית עלולה לגרום לנזק בילדים צעירים""",
            "order_index": 5
        },
        {
            "title": "טרליפרסין (גליפרסין) - Terlipressin",
            "section_type": "text",
            "content": """**Terlipressin (גליפרסין) - טרליפרסין**

**מנגנון:**
אנלוג של וזופרסין - מכווץ כלי דם

**מינון:**
💉 **2 mcg/kg**

**טווח מינון בילדים:**
- **2-5 mcg/kg**
- תדירות: **4-6 מנות ביום**

---

**⚠️ אזהרה חשובה:**
🚨 **יש לעקוב אחר פרפוזיה**

המשמעות:
- ניטור צבע עור
- זמן מילוי נימי (Capillary Refill)
- טמפרטורת גפיים
- תפוקת שתן

💡 כיווץ כלי דם עלול להשפיע על פרפוזיה היקפית""",
            "order_index": 6
        },
        {
            "title": "נקודות מפתח - תרופות החייאה",
            "section_type": "text",
            "content": """**🎯 נקודות מפתח:**

✅ **אדרנלין:** 0.01 mg/kg כל 2 דקות. מקסימום 1 mg. אין הגבלה בהחייאה

✅ **אטרופין:** 0.02 mg/kg. מינימום 0.1 mg (פחות ← תגובה פרדוקסלית!)

✅ **אדנוזין:** 0.1 ← 0.2 ← 0.3 mg/kg. מקסימום 6 ← 12 ← 12 mg

✅ **קלציום גלוקונט:** 100 mg/kg. מקסימום 2000 mg. שטיפה לפני ואחרי!

✅ **לידוקאין:** 1 mg/kg העמסה. הזרקה לאטית. המשך בעירוי

✅ **ביקרבונט:** 1 mEq/kg. דילול ×2 מתחת לגיל שנתיים

✅ **טרליפרסין:** 2-5 mcg/kg. 4-6 מנות ביום. עקוב אחר פרפוזיה""",
            "order_index": 7
        },
        {
            "title": "אזהרות קריטיות",
            "section_type": "text",
            "content": """**🚨 אזהרות חשובות:**

🔴 **אדנוזין:** יש לתת בוריד קרוב ללב + שטיפה מהירה. מתפרק מהר!

🔴 **אטרופין:** מינימום 0.1 mg. פחות מזה ← ברדיקרדיה פרדוקסלית!

🔴 **קלציום גלוקונט:** קריסטליזציה! שטיפה לפני ואחרי חובה

🔴 **לידוקאין:** אסור ב-Complete Heart Block (חוץ מקוצב)

🔴 **ביקרבונט:** דילול ×2 מתחת לגיל שנתיים

🔴 **טרליפרסין:** עקוב אחר פרפוזיה - כיווץ כלי דם""",
            "order_index": 8
        },
        {
            "title": "פנינים קליניות",
            "section_type": "text",
            "content": """**💎 פנינים קליניות:**

💎 **אדרנלין אינהלציה:** הכן מראש לאחר אקסטובציה (סבירות גבוהה לסטרידור)

💎 **אדנוזין:** חבר ECG בהדפסה רציפה וסמן איפה ניתנה התרופה

💎 **אטרופין בתינוקות:** מינימום 0.1 mg גבוה מ-0.02 mg/kg אך מקובל לתת

💎 **היפרקלמיה:** קלציום תחילה להגנה על הלב, אז אינסולין להורדת K

💎 **לידוקאין:** ניתן גם דרך טובוס (2-3 mg/kg + שטיפה + 5 הנשמות)

💎 **ביקרבונט:** בילדים צעירים תמיסה היפראוסמולרית מסוכנת ← דילול

💎 **קלציום יוני:** עוקבים בגזים, לא רק סידן כולל

💎 **דגש:** תרופות החייאה צריכות להיות **שאובות וזמינות בחדר**""",
            "order_index": 9
        }
    ]
    
    # הוספת כל המקטעים
    print(f"\n📚 מוסיף {len(sections)} מקטעים...")
    
    for idx, section_data in enumerate(sections, 1):
        section_data['topic_id'] = topic_id
        
        section = create_content_section(section_data)
        
        if section:
            print(f"   ✅ מקטע {idx}/{len(sections)}: {section_data['title']}")
        else:
            print(f"   ❌ שגיאה במקטע {idx}: {section_data['title']}")
            return False
    
    return True

if __name__ == "__main__":
    print("="*60)
    print("💊 הוספת תוכן: תרופות החייאה")
    print("="*60)
    
    try:
        success = add_resuscitation_medications()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - אדרנלין (אפינפרין)")
            print("   - אטרופין")
            print("   - אדנוזין")
            print("   - קלציום גלוקונט")
            print("   - לידוקאין")
            print("   - סודיום ביקרבונט")
            print("   - טרליפרסין (גליפרסין)")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
