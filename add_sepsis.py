#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: ספסיס ושוק ספטי - פרוטוקול טיפול
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_sepsis_content():
    """הוספת נושא ספסיס עם כל המקטעים"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: ספסיס ושוק ספטי...")
    
    topic_data = {
        "title": "ספסיס ושוק ספטי",
        "category": "resuscitation",
        "description": "זיהוי, דרגות חומרה, ופרוטוקול טיפול מלא בספסיס ושוק ספטי",
        "icon": "🚨",
        "slug": "sepsis_septic_shock",
        "tags": ["ספסיס", "שוק ספטי", "זיהום", "החייאה", "SIRS", "פרוטוקול"],
        "order_index": 10
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "הגדרה - ספסיס",
            "section_type": "alert",
            "content": """🚨 **ספסיס - מצב חירום רפואי!**

**Sepsis** = זיהום (חשוד או מאובחן) + תגובה דלקתית סיסטמית של הגוף

**מאפיינים מרכזיים:**

🦠 **זיהום:**
- חשד לזיהום, או זיהום מאובחן

🔴 **סימנים נלווים:**

**בילד לא יציב המודינמית:**
- פטכיות (נקודות דימום קטנות)
- פורפורה (שטחי דימום גדולים יותר)

**בילד עם לויקוציטוזיס ותסנין ריאתי:**
- חום
- שיעול
- היפוקסמיה

⚠️ **חשוב:** זיהוי מוקדם ומענה מהיר = הצלת חיים!""",
            "order_index": 0
        },
        {
            "title": "SIRS - Systemic Inflammatory Response Syndrome",
            "section_type": "text",
            "content": """**תסמונת תגובה דלקתית סיסטמית**

**הגדרה:**
דלקת סיסטמית שיכולה להיות קשורה או לא קשורה לזיהום.

**קריטריונים:**

🌡️ **חום:**
- חום **גבוה מ-38°C** או **נמוך מ-36°C**

🔬 **לויקוציטוזיס:**
- ספירת תאי דם לבנים גבוהה או נמוכה באופן חריג

📊 **הקשר לספסיס:**
**Sepsis = זיהום (חשוד/מאובחן) + SIRS**

כלומר, SIRS הוא קריטריון נדרש לאבחנת ספסיס, אך יכול להופיע גם ממצבים לא זיהומיים (כוויות, טראומה, דלקת לבלב).""",
            "order_index": 1
        },
        {
            "title": "דרגות ספסיס",
            "section_type": "text",
            "content": """**סיווג חומרת המצב:**

הספסיס מסווג לפי חומרה:

1️⃣ **Sepsis** - זיהום + SIRS
2️⃣ **Severe Sepsis** - ספסיס + אי ספיקת איברים
3️⃣ **Septic Shock** - שוק ספטי
4️⃣ **Refractory Septic Shock** - שוק עיקש""",
            "order_index": 2
        },
        {
            "title": "Severe Sepsis - ספסיס חמור",
            "section_type": "list",
            "content": """**הגדרה:**
ספסיס עם תפקוד לקוי של מערכות הגוף.

**קריטריונים - אחד מהבאים:**

🫀 **תפקוד קרדיווסקולרי ירוד**
- חוסר יציבות המודינמית
- צורך באמינים

🫁 **ARDS** (Acute Respiratory Distress Syndrome)
- אי ספיקת נשימה חריפה

🧠 **תפקוד לקוי של שתיים או יותר מהמערכות הבאות:**

- **נוירולוגית:** שינוי במצב ההכרה, GCS נמוך
- **המטולוגית:** טרומבוציטופניה < 80,000
- **כליות:** קריאטינין פי 2 מהרצוי לגיל
- **כבד:** הפרעה בתפקודי כבד""",
            "order_index": 3
        },
        {
            "title": "Septic Shock - שוק ספטי",
            "section_type": "alert",
            "content": """⚠️ **שוק ספטי - הגדרה:**

**Septic Shock =** ספסיס + חוסר תפקוד קרדיווסקולרי שנמשך **גם לאחר** החזר נוזלים איזוטוניים של **40 ml/kg תוך שעה**

🔴 **סימנים קליניים:**
- היפוטנסיה
- מילוי קפילרי איטי (> 3 שניות)
- דופק חלש
- אוליגוריה
- חמצת מטבולית
- לקטט עורקי מוגבר

💡 **מה זה אומר?**
למרות שנתנו הרבה נוזלים, המטופל עדיין במצב של שוק (אי ספיקה קרדיווסקולרית).""",
            "order_index": 4
        },
        {
            "title": "Refractory Septic Shock - שוק עיקש",
            "section_type": "options",
            "content": "שוק ספטי שלא מגיב לטיפול סטנדרטי:",
            "metadata": {
                "options": [
                    {
                        "title": "סוג 1 - עמידות לנוזלים",
                        "description": "**אין שיפור גם לאחר החזר נוזלים של 60 ml/kg**\n\nלמרות שנתנו כמות מרבית של נוזלים, המטופל עדיין בשוק."
                    },
                    {
                        "title": "סוג 2 - עמידות לאמינים",
                        "description": "**שוק שאינו מגיב ל:**\n- דופמין > 10 mcg/kg/min\n- **או** אדרנלין/נוראדרנלין\n\nזהו מצב קריטי במיוחד הדורש אסקלציה טיפולית (ECMO, תמיכה מכנית)."
                    }
                ]
            },
            "order_index": 5
        },
        {
            "title": "Multiple Organ Failure - קריסת מערכות",
            "section_type": "text",
            "content": """**אי ספיקה של מספר מערכות בו-זמנית**

כשהספסיס מתקדם, הוא יכול לגרום לנזק למספר איברים ומערכות.

להלן קריטריונים לכל מערכת:""",
            "order_index": 6
        },
        {
            "title": "קריסת מערכות - קרדיווסקולרית",
            "section_type": "list",
            "content": """🫀 **מערכת קרדיווסקולרית:**

- **היפוטנסיה** או צורך באמינים ליציבות המודינמית
- **חמצת מטבולית** (Metabolic acidosis)
- **עליית לקטט** (Lactate) - במדידה עורקית
- **אוליגוריה** - ירידה בתפוקת שתן
- **מילוי קפילרי איטי** (CRT > 3 שניות)

💡 **משמעות:** הלב לא מספק להשאיב מספיק דם לרקמות.""",
            "order_index": 7
        },
        {
            "title": "קריסת מערכות - נשימתית",
            "section_type": "list",
            "content": """🫁 **מערכת רספירטורית:**

- **CO₂ > 65 mmHg** או 20 mmHg מעל ה-Baseline
- צורך ב**יותר מ-50% חמצן** כדי להחזיק סטורציה > 92%
- **צורך מיידי בהנשמה** (אינטובציה)

💡 **משמעות:** הריאות לא מצליחות לספק חמצון נאות.""",
            "order_index": 8
        },
        {
            "title": "קריסת מערכות - נוירולוגית, המטולוגית, כלייתית, כבדית",
            "section_type": "list",
            "content": """🧠 **נוירולוגית:**
- **Glasgow Coma Scale < 11**
- **שינויים אקוטיים במצב ההכרה**

🩸 **המטולוגית:**
- **טסיות < 80,000**
- **DIC** (Disseminated Intravascular Coagulation) - קרישה תוך-וסקולרית מפושטת
- **PT/PTT מוארך**
- **פיברינוליזיס** - פירוק פיברינוגן ועליית ריכוזו בדם

🔬 **כליות:**
- **קריאטינין פי 2** מהרצוי בהתאם לגיל
- אוליגוריה או אנוריה

🧪 **כבד:**
- **בילירובין טוטאלי > 4 mg/dL**
- **ALT פי 2** מהרצוי בהתאם לגיל""",
            "order_index": 9
        },
        {
            "title": "פרוטוקול טיפול - זמני מענה קריטיים",
            "section_type": "alert",
            "content": """⏰ **Time is Life - זמן = חיים!**

🚨 **בחשד לספסיס:**
טיפול תוך **3 שעות** מרגע החשד

🚨 **בספסיס מאובחן:**
טיפול תוך **שעה אחת!**

⚠️ **חשוב ביותר:**
**לא לעכב מתן אנטיביוטיקה בגלל לקיחת תרביות!**
- אם לקיחת תרבית תעכב את האנטיביוטיקה → מוותרים על התרבית
- מתחילים אנטיביוטיקה מיד""",
            "order_index": 10
        },
        {
            "title": "שלבי הטיפול בספסיס",
            "section_type": "steps",
            "content": "פרוטוקול טיפול שלב אחר שלב:",
            "metadata": {
                "steps": [
                    "**וידוא גישה ורידית** - מוודאים שיש IV פועל (או מכניסים מיד)",
                    "**תרבית דם** - לוקחים מיד (אם לא מעכב אנטיביוטיקה!)",
                    "**אנטיביוטיקה רחבת טווח** - מתחילים מיד: **מרופנם 20 mg/kg**",
                    "**רמות לקטט** - בודקים (לקטט שלילי לא שולל ספסיס, אך חיובי מאשש)",
                    "**החזר נוזלים** - מתחילים מ-10-20 ml/kg, מעריכים מחדש, חוזרים עד 60 ml/kg (או סימני fluid overload)",
                    "**הערכת תפקוד לבבי** - Echo/בדיקה קלינית",
                    "**שקילת אמינים** - אדרנלין אם תפקוד לבבי לקוי, נוראדרנלין אם שוק נמשך למרות 60 ml/kg",
                    "**הערכת Fluid Overload** - ניטור סימנים (ראה מקטע נפרד)",
                    "**שוק ספטי עיקש** - שקול **הידרוקורטיזון** (יש מחלוקת, אצלנו נותנים)",
                    "**תמיכה תזונתית** - מניעת היפוגליקמיה. לא בשלב שוק ותמיכה באמינים גבוהים, אך מיד לאחר התייצבות → **הזנה אנטרלית** (עדיף על פרנטרלית)",
                    "**הנשמה במידת הצורך** - כדי להקל על המטופל אם הוא מתנשם",
                    "**תמיכת ECMO** - במקרים קיצוניים של שוק עיקש"
                ]
            },
            "order_index": 11
        },
        {
            "title": "Source Control - איתור ושליטה במקור הזיהום",
            "section_type": "alert",
            "content": """🔍 **למצוא את הגורם לזיהום!**

**חשוב ביותר:** לא מספיק לתת אנטיביוטיקה - צריך **לטפל במקור**.

⚠️ **דוגמה קריטית - צנתר מרכזי:**

**אם חושדים שהצנתר גורם לספסיס:**

✅ **יש צנתר נוסף:**
→ **להוציא מיד** את הצנתר החשוד

❌ **אין צנתר נוסף:**
→ **לא מוציאים!** כי דרכו נותנים את כל הטיפול מציל החיים
→ שוקלים החלפה מאוחר יותר כשהמטופל יציב

**מקורות זיהום נוספים לשקול:**
- אבצס - ניקוז
- זיהום בשתן - החלפת צנתר שתן
- דלקת ריאות - פיזיותרפיה, שאיבות
- זיהום פצע - שטיפה, החלפת חבישות""",
            "order_index": 12
        },
        {
            "title": "Fluid Overload - זיהוי ומשמעות",
            "section_type": "list",
            "content": """💧 **סימנים לעומס נוזלים:**

**בדיקה גופנית:**
- 🫀 **צניחה של כבד** (Hepatomegaly) - הכבד משמש כ"מאגר" לנוזלים
- 🫁 **בצקת ריאות** - האזנה: **קרפיטציות וחרחורים**
- 🦵 **בצקות פריפריות** (רגליים, ידיים)

**משמעות קלינית:**
עומס על הלב → עומס על הריאות → **החמרה המודינמית!**

⚠️ **למה זה בעיה?**
הנוזלים מחמירים את מצב הלב והריאות במקום לשפר.

💡 **מסקנה:**
כשיש סימנים ל-fluid overload → **להפסיק בולוסים** של נוזלים, לשקול דיאורטיקה (פורוזמיד).""",
            "order_index": 13
        },
        {
            "title": "ניטור והערכת יציבות",
            "section_type": "list",
            "content": """📊 **הערכת יציבות המטופל לאחר מענה ראשוני:**

**פרמטרים לניטור:**

- 🔬 **SVO₂** (Mixed Venous O₂ Saturation) - סטורציה ורידית מעורבת
- 💓 **דופק** - קצב ואיכות
- 🩸 **סטורציה** (SpO₂)
- 🩺 **לחץ דם** - MAP (Mean Arterial Pressure)
- 🧪 **לקטט** - מדד לפרפוזיה רקמתית
- 🫀 **פרפוזיה פריפרית** - חום גפיים, צבע עור
- ⏱️ **מילוי קפילרי** (CRT - Capillary Refill Time)
- 💧 **תפוקת שתן** (Urine output)

🎯 **ברגע שהמטופל יציב המודינמית:**
- **מפסיקים בולוסים** של נוזלים
- **שוקלים Maintenance** בלבד
- **ממשיכים השגחה וניטור** מתמשך""",
            "order_index": 14
        },
        {
            "title": "תרופות נוספות - עדכונים מההנחיות",
            "section_type": "list",
            "content": """💊 **תעדוף תרופות לחץ דם:**

✅ **מועדפים:**
- **נוראדרנלין** (Norepinephrine) - vasopressor ראשון
- **אדרנלין** (Epinephrine) - אם תפקוד לבבי לקוי

⚠️ **לא מועדף:**
- **דופמין** (Dopamine) - פחות יעיל, יותר תופעות לוואי

🤔 **לא גובשה החלטה:**
- **דובוטמין** (Dobutamine) ו**מילרינון** (Milrinone)
- **אצלנו:** כן נותנים **לאחר** שהמטופל כבר יציב

💉 **IVIG (Immunoglobulin):**
- **לא מומלץ ברוטינה**
- **בילדים עם חסר חיסוני:** ידונו בזה **לאחר** שלב השוק

🩸 **עירוי טסיות:**
- **לרוב לא נותנים** רק בגלל שהמספר ירד
- **בנאונייטס (Neonates):** כן נותנים לרוב (נטייה לדמם מהמוח)
- **בילדים עם נטייה לדימומים:** גם נותנים""",
            "order_index": 15
        },
        {
            "title": "Guideline רשמי + נקודות מפתח",
            "section_type": "alert",
            "content": """📋 **לצפייה ב-Guideline המלא:**

🔗 [לחץ כאן לקישור ל-Guideline](https://did.li/vWdrl)

---

🔑 **נקודות מפתח לזכור:**

1️⃣ **זמן = חיים:**
   - חשד לספסיס → טיפול תוך 3 שעות
   - ספסיס מאובחן → טיפול תוך שעה

2️⃣ **אנטיביוטיקה מיד:**
   - לא לעכב בגלל תרביות!
   - מרופנם 20 mg/kg

3️⃣ **נוזלים אגרסיביים:**
   - 10-20 ml/kg בכל פעם
   - עד 60 ml/kg או עד fluid overload

4️⃣ **Source Control:**
   - למצוא ולטפל במקור הזיהום
   - שיקול מושכל לגבי צנתרים

5️⃣ **אמינים:**
   - נוראדרנלין/אדרנלין מועדפים על דופמין
   - התאם לתפקוד הלבבי

6️⃣ **ניטור מתמיד:**
   - SVO₂, לקטט, לחץ דם, CRT
   - הפסקת נוזלים ברגע שיציב

7️⃣ **ECMO:**
   - באופציה בשוק עיקש

8️⃣ **תזונה:**
   - מניעת היפוגליקמיה
   - חזרה מהירה להזנה אנטרלית""",
            "order_index": 16
        }
    ]
    
    print(f"\n📑 מוסיף {len(sections)} מקטעים...")
    
    for idx, section in enumerate(sections, 1):
        section['topic_id'] = topic_id
        result = create_content_section(section)
        
        if result:
            print(f"  ✅ {idx}. {section['title']}")
        else:
            print(f"  ❌ {idx}. {section['title']} - נכשל")
    
    print("\n" + "="*60)
    print("✅ התוכן נוסף בהצלחה למסד הנתונים!")
    print("="*60)
    print(f"\n📊 סיכום:")
    print(f"   נושא: ספסיס ושוק ספטי")
    print(f"   קטגוריה: החייאה")
    print(f"   מקטעים: {len(sections)}")
    print(f"   ID: {topic_id}")
    
    return True

if __name__ == "__main__":
    print("🚨 PICU Learning Platform - הוספת תוכן")
    print("="*60)
    print("נושא: ספסיס ושוק ספטי")
    print("="*60)
    
    try:
        success = add_sepsis_content()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - הגדרות: Sepsis, SIRS, Severe Sepsis")
            print("   - דרגות חומרה ושוק ספטי")
            print("   - Multiple organ failure")
            print("   - פרוטוקול טיפול 12 שלבים")
            print("   - Source control ו-Fluid overload")
            print("   - ניטור ותרופות")
            print("   - קישור ל-Guideline רשמי")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
