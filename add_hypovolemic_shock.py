#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
הוספת תוכן: הלם/שוק היפוולמי-המורגי
"""

from utils.database import init_supabase, create_content_item, create_content_section

def add_hypovolemic_shock_content():
    """הוספת נושא שוק היפוולמי עם כל המקטעים"""
    
    print("🔄 מתחבר למסד הנתונים...")
    supabase = init_supabase()
    
    if not supabase:
        print("❌ שגיאה בחיבור למסד נתונים")
        return False
    
    print("✅ חיבור הצליח!")
    
    # יצירת הנושא הראשי
    print("\n📝 יוצר נושא: הלם היפוולמי-המורגי...")
    
    topic_data = {
        "title": "הלם/שוק היפוולמי-המורגי",
        "category": "resuscitation",
        "description": "זיהוי שלבי שוק היפוולמי, מנגנוני פיצוי, וטיפול",
        "icon": "💧",
        "slug": "hypovolemic_hemorrhagic_shock",
        "tags": ["שוק", "היפוולמי", "דימום", "התייבשות", "החייאה", "נוזלים"],
        "order_index": 15
    }
    
    topic = create_content_item(topic_data)
    
    if not topic:
        print("❌ שגיאה ביצירת הנושא")
        return False
    
    topic_id = topic['id']
    print(f"✅ נושא נוצר בהצלחה! ID: {topic_id}")
    
    # הוספת מקטעים
    sections = [
        {
            "title": "הגדרה - שוק היפוולמי",
            "section_type": "alert",
            "content": """🚨 **Hypovolemic/Hemorrhagic Shock**

**הגדרה:**
מצב **פתופיזיולוגי דינמי ולא יציב** המאופיין ב**פרפוזיה לקויה לרקמות**.

**המשמעות:**
- 💧 **היפוולמי** - מחסור בנפח הדם במחזור
- 🩸 **המורגי** - כתוצאה מדימום/אובדן דם
- 🔄 **דינמי** - המצב משתנה ומתפתח
- ⚠️ **לא יציב** - עלול להידרדר במהירות
- 🫀 **פרפוזיה לקויה** - אספקת דם לא מספקת לרקמות ואיברים

⏰ **התערבות מהירה ואגרסיבית עשויה למנוע תוצאה עגומה של אי אספקת דם לאיברים!**

🎯 **מהירות הטיפול קריטית!**""",
            "order_index": 0
        },
        {
            "title": "גורמים לשוק היפוולמי",
            "section_type": "list",
            "content": """**סיבות לאובדן נפח הדם:**

💧 **התייבשות:**
- הקאות ושלשולים
- מיעוט שתייה
- חום גבוה

🩸 **דימום:**
- טראומה
- דימום פנימי (GI, ניתוח)
- דימום חיצוני

💦 **השתנה מרובה:**
- היפרגליקמיה (סוכרת לא מאוזנת)
- סוכרת אינסיפידוס

🫧 **דליפה קפילרית (Third Space Loss):**
- **תהליכים תוך-בטניים:** איבוד נוזלים לחלל השלישי
  - פנקריאטיטיס
  - אפנדיציטיס
  - השתפלות מעי (Intussusception)
- **כוויות:** אובדן נוזלים דרך העור

🌡️ **חום:**
- הזעה מוגברת
- איבוד נוזלים לא מורגש (insensible losses)""",
            "order_index": 1
        },
        {
            "title": "מנגנוני פיצוי (Compensation)",
            "section_type": "text",
            "content": """**הגוף מנסה לפצות על אובדן הנפח בשלוש דרכים:**

הבנת מנגנוני הפיצוי חשובה לזיהוי מוקדם של השוק!

להלן המנגנונים השונים:""",
            "order_index": 2
        },
        {
            "title": "פיצוי 1: טכיקרדיה",
            "section_type": "list",
            "content": """💓 **Tachycardia - דופק מהיר**

**מנגנון:**
טכיקרדיה מעלה את **תפוקת הלב** (Cardiac Output)

**אבל - יש מחיר:**

❌ **קיצור זמן מילוי החדרים:**
- הלב פועם מהר מדי
- החדרים לא מספיקים להתמלא במלואם
- ⬇️ **ירידה בנפח הפעימה** (Stroke Volume)
- ⬇️ **בסופו של דבר - ירידה בתפוקת הלב**

💡 **מסקנה:**
טכיקרדיה היא **סימן מוקדם** לשוק, אך אינה יכולה לפצות לאורך זמן!""",
            "order_index": 3
        },
        {
            "title": "פיצוי 2: עליית תנגודת היקפית",
            "section_type": "list",
            "content": """🔒 **SVR - Systemic Vascular Resistance**

**מנגנון:**
עלייה בתנגודת הכלי-דמית ההיקפית

**שליטה על ידי:**
- 🧠 **מערכת העצבים המרכזית** (CNS)
- 🔄 **מערכת רנין-אנגיוטנסין-אלדוסטרון** (RAAS)

**התוצאה:**
- 🚫 **הגבלת זרימת הדם בפריפריה** (כלי דם מתכווצים)
- ✅ **זרימה מועדפת ללב ומוח** - איברים חיוניים!
- 🥶 **ביטוי קליני:** גפיים קרות, חיוורות, מילוי קפילרי איטי

💡 **Centralization** - ריכוז הדם באיברים החיוניים על חשבון הפריפריה""",
            "order_index": 4
        },
        {
            "title": "פיצוי 3: כיווץ מוגבר של שריר הלב",
            "section_type": "list",
            "content": """💪 **Increased Myocardial Contractility**

**מנגנון:**
אפקט **אינוטרופי חיובי** (Positive Inotropic Effect)

**המשמעות:**
- 🫀 שריר הלב מתכווץ **בעוצמה רבה יותר**
- 💧 **ריקון טוב יותר של החדרים** (Better Ejection Fraction)
- 🎯 **שימור נפח הדם** - ניצול מקסימלי של הדם הקיים

**השפעה:**
עוזר לשמור על תפוקת לב תקינה למרות הירידה בנפח הדם

💡 **זה המנגנון שמאפשר לילדים לשמור על לחץ דם תקין גם כשכבר איבדו נפח משמעותי!**""",
            "order_index": 5
        },
        {
            "title": "נקודה קריטית - ירידת לחץ דם בילדים",
            "section_type": "alert",
            "content": """⚠️ **חשוב ביותר לזכור!**

**בילדים:**
ירידת לחץ הדם תתרחש **בשלב מאוחר** ומאותתת על **דום לב מתקרב!**

**למה זה קורה?**
- ילדים מפצים טוב מאוד (מנגנוני פיצוי יעילים)
- לחץ הדם נשאר תקין עד שאיבדו **30-40%** מנפח הדם!
- ברגע שלחץ הדם יורד = **מצב קריטי!**

🚨 **אל תחכו לירידת לחץ דם!**

**זהו סימנים מוקדמים:**
- טכיקרדיה
- מילוי קפילרי איטי
- גפיים קרות
- ירידה בתפוקת שתן
- שינוי במצב ההכרה

💡 **היפוטנסיה בילד = Decompensated Shock = מצב קריטי מיידי!**""",
            "order_index": 6
        },
        {
            "title": "5 שלבי שוק היפוולמי - סקירה",
            "section_type": "text",
            "content": """**סיווג השוק לפי חומרה:**

השוק ההיפוולמי מתקדם בהדרגה דרך 5 שלבים, מפיצוי מלא ועד קריסה מוחלטת.

**השלבים:**

🟢 **שלב 1** - Compensated (יש פיצוי מלא)
🟡 **שלב 2** - Early Decompensation (התחלת דקומפנסציה)
🟠 **שלב 3** - Decompensated (אובדן פיצוי)
🔴 **שלב 4** - Severe Decompensation (דקומפנסציה חמורה)
⚫ **שלב 5** - Cardiac Arrest (דום לב)

להלן פירוט של כל שלב:""",
            "order_index": 7
        },
        {
            "title": "שלב 1 - Compensated Shock",
            "section_type": "list",
            "content": """🟢 **שלב 1: יש קומפנסציה (פיצוי)**

**מאפיינים:**

✅ **לחץ דם:** תקין
✅ **מילוי קפילרי:** תקין (< 2 שניות)
✅ **דופק:** תקין/מעט מהיר
✅ **נשימה:** תקינה
✅ **מצב מנטלי:** תקין
✅ **מרפס (Fontanelle):** תקין (בתינוקות)

**אובדן נפח משוער:** < 10-15%

💡 **קשה לזהות!**
המטופל נראה יציב, אך כבר איבד נפח. יש לחפש אנמנזה (הקאות, שלשולים, דימום).

🎯 **טיפול בשלב זה:** החזר נוזלים פומי או IV מוקדם יכול למנוע התדרדרות!""",
            "order_index": 8
        },
        {
            "title": "שלב 2 - Early Decompensation",
            "section_type": "list",
            "content": """🟡 **שלב 2: התחלת דקומפנסציה**

**מאפיינים:**

📊 **לחץ דם:** נורמלי / מעט נמוך (Systolic עדיין מעל 70 + 2×גיל)
🥶 **מילוי קפילרי:** **איטי** (> 3 שניות)
💦 **זיעה:** **קרה** (cold sweat)
💓 **דופק:** **עולה** (Tachycardia)
🫁 **קצב נשימות:** **עולה** (Tachypnea)
💧 **שתן:** **ירידה בכמות** (Oliguria)
👶 **מרפס:** **שקוע** (בתינוקות)
👁️ **עיניים:** **שקועות**

**אובדן נפח משוער:** 15-25%

💡 **כאן מתחיל להיות ברור שיש בעיה!**
סימני הפיצוי הופכים נראים לעין.

🎯 **טיפול:** החזר נוזלים IV אגרסיבי - 10-20ml/kg בולוסים""",
            "order_index": 9
        },
        {
            "title": "שלב 3 - Decompensated Shock",
            "section_type": "alert",
            "content": """🟠 **שלב 3: דקומפנסציה - מנגנוני הפיצוי נכשלים**

**מאפיינים:**

🚨 **לחץ דם סיסטולי:** **צונח!** (< 70 + 2×גיל)
❄️ **מילוי קפילרי:** **איטי מאוד** (> 4-5 שניות)
💓 **טכיקרדיה:** בולטת
🫁 **טכיפניאה:** בולטת
🧠 **מצב הכרה:** **שינויים!** (lethargy, confusion, irritability)
💦 **הזעה:** ניכרת
🥶 **עור:** **חיוור וקר**
💧 **כמות שתן:** **ירודה מאוד** (< 0.5ml/kg/hr)
👶 **מרפס:** **שקוע מאוד**
👁️ **עיניים:** **שקועות מאוד**

**אובדן נפח משוער:** 25-35%

⚠️ **זהו שלב קריטי!**
מנגנוני הפיצוי כשלו, לחץ הדם יורד.

🎯 **טיפול מיידי:**
- בולוסים של 20ml/kg עד 60ml/kg
- שקול אמינים
- הערכה לטיפול נמרץ""",
            "order_index": 10
        },
        {
            "title": "שלב 4 - Severe Decompensation",
            "section_type": "alert",
            "content": """🔴 **שלב 4: דקומפנסציה חמורה - סף דום לב**

**מאפיינים:**

🚨 **לחץ דם סיסטולי:** **ירוד מאוד** (< 50-60)
❌ **מילוי קפילרי:** **אין** (> 5 שניות או בלתי נראה)
💓 **טכיקרדיה:** קיצונית (או מתחיל לרדת - סימן רע!)
🫁 **טכיפניאה:** קיצונית או gasping
💨 **דופק:** **חלש מאוד** (thready pulse)
💦 **זיעה:** **קרה**
🥶 **עור:** **חיוור**, קר, מנומר (mottled)
🧠 **הכרה:** **חוסר הכרה / קומה**
💧 **שתן:** **אנוריה** (0)
🧪 **לקטט:** **עליה** (> 4-5mmol/L)

**אובדן נפח משוער:** 35-45%

⚠️ **מצב טרום-דום לב!**

🎯 **טיפול:**
- החייאה מלאה
- בולוסי נוזלים מסיביים
- אמינים במינון גבוה
- שקול דם/פלזמה
- הכנה לדום לב""",
            "order_index": 11
        },
        {
            "title": "שלב 5 - Cardiac Arrest",
            "section_type": "alert",
            "content": """⚫ **שלב 5: דום לב**

**מאפיינים:**

💔 **ברדיקרדיה** → **אסיסטולה** או PEA

🧪 **מעבדה:**
- **ביקרבונט נמוך** (חמצת מטבולית חמורה)
- **לקטט גבוה מאוד** (> 8-10mmol/L)
- הפרעות אלקטרוליטים (K⁺, Ca²⁺)

**אובדן נפח משוער:** > 45%

🚨 **זהו סוף המסלול אם לא מטפלים מוקדם!**

🎯 **טיפול:**
- **CPR מלא** (לחיצות חזה, הנשמה)
- בולוסי נוזלים + דם
- אדרנלין במינון החייאה
- טיפול בגורם (דימום, נוזלים)
- **ECMO** במקרים נבחרים

💡 **המסר:** לא להגיע לכאן! טיפול מוקדם בשלבים 1-2 מציל חיים.""",
            "order_index": 12
        },
        {
            "title": "טבלת השוואה - 5 השלבים",
            "section_type": "text",
            "content": """**סיכום משווה של כל השלבים:**

| **פרמטר** | **שלב 1** | **שלב 2** | **שלב 3** | **שלב 4** | **שלב 5** |
|-----------|-----------|-----------|-----------|-----------|-----------|
| **מצב** | מפוצה | התחלה | דקומפנסציה | חמור | דום לב |
| **לחץ דם** | ✅ תקין | ⚠️ נמוך מעט | 🔴 צונח | 🔴🔴 ירוד | ❌ אין |
| **CRT** | < 2 שניות | > 3 שניות | > 4 שניות | > 5 שניות / אין | אין |
| **דופק** | תקין | ⬆️ עולה | ⬆️⬆️ גבוה | ⬆️⬆️⬆️ / ⬇️ יורד | ⬇️⬇️ ברדי |
| **הכרה** | ✅ תקינה | ⚠️ עייפות | 🔴 שינויים | 🔴🔴 קומה | ❌ אין |
| **שתן** | ✅ תקין | ⬇️ פחות | ⬇️⬇️ מעט | ⬇️⬇️⬇️ אנוריה | אין |
| **עור** | ✅ תקין | 🥶 קר/זיעה | 🥶🥶 חיוור/קר | 🥶🥶🥶 מנומר | ציאנוזה |
| **אובדן נפח** | < 15% | 15-25% | 25-35% | 35-45% | > 45% |
| **לקטט** | תקין | מעט ⬆️ | ⬆️⬆️ | ⬆️⬆️⬆️ | ⬆️⬆️⬆️⬆️ |

🎯 **מטרה:** לזהות ולטפל בשלבים 1-2 ולמנוע התקדמות!""",
            "order_index": 13
        },
        {
            "title": "אלגוריתם טיפול בשוק היפוולמי",
            "section_type": "list",
            "content": """🔄 **מסלול טיפולי מובנה:**

```
┌─────────────────────────────────┐
│  חשד לשוק היפוולמי             │
│  (טכיקרדיה + סימני פיצוי)      │
└─────────────────────────────────┘
              ↓
┌─────────────────────────────────┐
│  הערכה ראשונית                 │
│  • ABC                         │
│  • גישה ורידית/תוך-עצמית       │
│  • מוניטור + חמצן               │
│  • דגימות דם + תרבית            │
└─────────────────────────────────┘
              ↓
┌─────────────────────────────────┐
│  טיפול נוזלי אגרסיבי            │
│  20ml/kg NS/LR מעל 10-20 דק'   │
└─────────────────────────────────┘
              ↓
       ┌──────┴──────┐
       │  תגובה?     │
       └──────┬──────┘
         ↙        ↘
      כן           לא
       ↓            ↓
┌──────────┐   ┌─────────────────┐
│ המשך     │   │ חזור על בולוס   │
│ ניטור    │   │ 20ml/kg         │
│ ושמירה   │   │ (עד 60ml/kg)    │
└──────────┘   └─────────────────┘
                      ↓
              ┌───────────────────┐
              │ בדוק דימום פעיל  │
              └───────────────────┘
                 ↙          ↘
            יש דימום      אין דימום
                ↓              ↓
         ┌──────────┐    ┌──────────┐
         │ הכן דם   │    │ המשך     │
         │ PRBC     │    │ נוזלים   │
         │ 10ml/kg  │    │ + אמינים │
         └──────────┘    └──────────┘
                ↓              ↓
         ┌──────────────────────────┐
         │ עדיין לא יציב?           │
         │ • שקול אינוטרופים        │
         │ • חפש גורם נוסף          │
         │ • שקול ICU/החייאה        │
         └──────────────────────────┘
```

**🎯 נקודות מפתח באלגוריתם:**

📌 **בולוס ראשון:**
- 20ml/kg NS או Lactated Ringer
- מתן מהיר (10-20 דקות)
- הערכת תגובה לאחר מכן

📌 **אם אין תגובה:**
- חזור על בולוס 20ml/kg
- ניתן עד 60ml/kg בשעה הראשונה
- שקול אמינים אם עדיין לא יציב

📌 **דימום פעיל:**
- PRBC 10ml/kg
- שקול פלזמה ואבחנה-תרופה:1 יחס 1:1:1
- טיפול כירורגי במידת הצורך

📌 **אמינים (Vasopressors):**
- **נוראפינפרין:** קו ראשון אם SVR נמוך
- **אדרנלין:** אם יש ברדיקרדיה או דום לב
- **דופמין:** אלטרנטיבה (פחות מומלץ)

💡 **זכור:** אלגוריתם זה הוא קו מנחה - התאם לפי מצב הילד ותגובתו!""",
            "order_index": 13
        },
        {
            "title": "נקודות מפתח לזכירה",
            "section_type": "alert",
            "content": """🔑 **עקרונות חשובים בשוק היפוולמי:**

1️⃣ **מהירות הטיפול קריטית!**
   - התערבות מוקדמה מונעת נזק איברים

2️⃣ **בילדים - לחץ דם תקין לא שולל שוק!**
   - ילדים מפצים מצוין עד שלב מאוחר
   - היפוטנסיה = שלב מתקדם!

3️⃣ **חפש סימנים מוקדמים:**
   - טכיקרדיה
   - מילוי קפילרי איטי
   - ירידה בתפוקת שתן
   - גפיים קרות

4️⃣ **שלושה מנגנוני פיצוי:**
   - טכיקרדיה (אך לא יעיל לאורך זמן)
   - SVR מוגבר (centralization)
   - contractility מוגברת

5️⃣ **5 שלבים:**
   - 1-2: מפוצה/התחלה → טיפול פשוט יעיל
   - 3: דקומפנסציה → טיפול אגרסיבי
   - 4-5: קריטי/דום לב → החייאה מלאה

6️⃣ **גורמים שכיחים:**
   - התייבשות (הקאות/שלשולים)
   - דימום
   - Third space loss
   - כוויות

7️⃣ **טיפול:**
   - נוזלים IV: 10-20ml/kg בולוסים
   - עד 60ml/kg בשעה הראשונה
   - דם בדימום פעיל
   - אמינים במידת הצורך

💡 **זכור:** Early Recognition + Aggressive Treatment = Survival""",
            "order_index": 14
        }
    ]
    
    print(f"\n📑 מוסיף {len(sections)} מקטעים...")
    
    for idx, section in enumerate(sections, 1):
        section['topic_id'] = topic_id
        result = create_content_section(section)
        
        if result:
            print(f"  ✅ {idx}. {section['title']}")
        else:
            print(f"  ❌ {idx}. {section['title']} - נכשל")
    
    print("\n" + "="*60)
    print("✅ התוכן נוסף בהצלחה למסד הנתונים!")
    print("="*60)
    print(f"\n📊 סיכום:")
    print(f"   נושא: הלם/שוק היפוולמי-המורגי")
    print(f"   קטגוריה: החייאה")
    print(f"   מקטעים: {len(sections)}")
    print(f"   ID: {topic_id}")
    
    return True

if __name__ == "__main__":
    print("💧 PICU Learning Platform - הוספת תוכן")
    print("="*60)
    print("נושא: הלם/שוק היפוולמי-המורגי")
    print("="*60)
    
    try:
        success = add_hypovolemic_shock_content()
        
        if success:
            print("\n🎉 הושלם בהצלחה!")
            print("\n💡 התוכן כולל:")
            print("   - הגדרה וגורמים")
            print("   - 3 מנגנוני פיצוי מפורטים")
            print("   - 5 שלבי שוק עם סימנים קליניים")
            print("   - טבלת השוואה")
            print("   - נקודות מפתח")
        else:
            print("\n❌ הייתה בעיה בהוספת התוכן")
    
    except Exception as e:
        print(f"\n❌ שגיאה: {e}")
        import traceback
        traceback.print_exc()
